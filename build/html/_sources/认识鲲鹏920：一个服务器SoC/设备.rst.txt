.. Copyright by Kenneth Lee. 2020. All Right Reserved.

设备
====

介绍
-----
鲲鹏920有两种设备，一种是连在网桥上的设备，这种设备每个基于Station的DAW窗口，有自己的MMIO空间，
也有DMA机制，可以通过IOMMU访问内存，这种设备的基本接口是比较容易理解的。

还有一类设备就复杂了，这种设备通过PCIe总线和USB总线动态插入到系统中，这种动态的
过程为系统引入了更多的复杂性。

为了让软件生态融合，鲲鹏920选择把片内的设备也模拟成PCIe的访问接口，这些设备具有
直接接在总线上的性能，但从软件的角度看来，它们的访问接口和其他动态插入到系统中
的PCIe设备是一样的。本章讨论所有这些设备的工作逻辑。


PCIe
-----

综述
````
PCIe是一种从PCI总线发展过来的，广泛使用的高速外设总线。正如我们前面提到的，为了
让时钟频率可以提上去，现在大部分的外设总线都是基于Serdes的多Lane P2P串行总线。
PCIe也不例外，它不再使用PCI的并行结构，而是一种多层网桥的形式，图示如下：

.. figure:: pcie-arch.svg

可以看到，和鲲鹏的系统总线不同，PCIe是一个树桩的分层结构，连在总线上的可以是一
个终点（EP，End Point），也可以是一个网桥，把路径分到下一层，接入下一个网桥，也
可以接入下一个EP。这样，其他设计就不能假设它是一个单一的通讯结构，这会增加很多
其他的复杂度：比如必须有协议保证EP和EP间，EP和网桥间，网桥和网桥间通讯不会互锁
或者自环。

PCIe总线协议分3层：

* 会话层：定义总线不同业务，比如内存访问，中断，低功耗处理等的通讯和消息协议
* 数据链路层：定义会话，链路，通道等协议
* 物理层：定义Serdes层的协议要求

（顺便提一句，鲲鹏920支持CCIX协议，这个协议工作在PCIe的数据链路层上，替换了会话
层，通过修改鲲鹏920的PCIe控制器，可以让这个端口工作在CCIX模式）

todo: 补充一些会话层的基本协议和功能

设备发现和访问协议
```````````````````
todo

鲲鹏920的真实和虚拟PCIe设备实现
````````````````````````````````
todo

SR-IOV
```````
todo

..
        支持特性：PCIE4：
        6.1. PME, 
        6.2. Error Signal and Logging
        6.3. VC (仅CCIX支持）
        6.4. Device Synchronization
        6.6. PCIE reset
        6.7. PCIE Hot Plug
        6.10. Root Complex Topology Discovery
        6.11. Link Speed Management
        6.12. ACS
        6.13. ARI
        6.15. Atomic Operations (inbound only)
        6.17 TPH
        6.20 PASID
        6.23 RN

.. PCIe ICL提供RC功能，最多支持20个V4RP

USB
----
todo
