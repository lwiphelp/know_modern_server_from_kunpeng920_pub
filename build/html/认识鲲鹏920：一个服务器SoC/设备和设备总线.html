

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="zh-CN" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="zh-CN" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>设备和设备总线 &mdash; 从鲲鹏920了解现代服务器实现和应用 0.1a1 文档</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script type="text/javascript" src="../_static/translations.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
    <link rel="next" title="管理系统" href="管理系统.html" />
    <link rel="prev" title="中断" href="中断.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> 从鲲鹏920了解现代服务器实现和应用
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../序.html">序</a></li>
<li class="toctree-l1"><a class="reference internal" href="../感谢.html">感谢</a></li>
<li class="toctree-l1"><a class="reference internal" href="../认识服务器/index.html">认识服务器</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">认识鲲鹏920：一个服务器SoC</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="综述.html">综述</a></li>
<li class="toctree-l2"><a class="reference internal" href="总线.html">总线</a></li>
<li class="toctree-l2"><a class="reference internal" href="软件构架.html">软件架构</a></li>
<li class="toctree-l2"><a class="reference internal" href="Linux内核软件架构基础.html">Linux内核软件架构基础</a></li>
<li class="toctree-l2"><a class="reference internal" href="地址空间.html">地址空间</a></li>
<li class="toctree-l2"><a class="reference internal" href="Cache.html">Cache</a></li>
<li class="toctree-l2"><a class="reference internal" href="Cache.html#cache-coherency">Cache Coherency</a></li>
<li class="toctree-l2"><a class="reference internal" href="中断.html">中断</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">设备和设备总线</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#pcie">PCIe</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id2">地址空间</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id3">鲲鹏920的实际和虚拟PCIe接口</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id4">中断处理</a></li>
<li class="toctree-l3"><a class="reference internal" href="#io">IO虚拟化</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="管理系统.html">管理系统</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../计算子系统/index.html">计算子系统</a></li>
<li class="toctree-l1"><a class="reference internal" href="../网络子系统/index.html">网络子系统</a></li>
<li class="toctree-l1"><a class="reference internal" href="../存储子系统/index.html">存储子系统</a></li>
<li class="toctree-l1"><a class="reference internal" href="../RAS设计/index.html">RAS设计</a></li>
<li class="toctree-l1"><a class="reference internal" href="../未来展望.html">未来展望</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">从鲲鹏920了解现代服务器实现和应用</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">认识鲲鹏920：一个服务器SoC</a> &raquo;</li>
        
      <li>设备和设备总线</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/认识鲲鹏920：一个服务器SoC/设备和设备总线.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="id1">
<h1>设备和设备总线<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h1>
<p>前面介绍总线的时候我们介绍了鲲鹏的总线结构，本章我们看看设备是怎么连到总线上的。</p>
<p>忽略一些非关键功能的辅助设备，基于鲲鹏920构成的系统主要有两种类型的设备，一种内
置在SoC内，直接连接在NoC上。另一种是片外的，这些设备主要通过PCIe总线接入系统。
还有一些非高速设备使用其他一些特殊手段连接的，那些不是设计的重点，我们先忽略，
等需要介绍特定的设计的时候再讨论。</p>
<p>为了软件编程的方便，鲲鹏920的片内设备也提供PCIe一样的编程接口，所以，要理解这些
设备的设计，我们也需要先了解PCIe的工作原理。</p>
<div class="section" id="pcie">
<h2>PCIe<a class="headerlink" href="#pcie" title="永久链接至标题">¶</a></h2>
<p>PCIe从PCI接口发展而来，它向前兼容PCI的软硬件接口，旧的PCI接口卡可以插到PCIe的硬
件插槽中，旧的PCI驱动也可以直接驱动这些设备。这一方面带来了生态上的稳定，但另一
方面也带来很多不必要的负担。</p>
<p>正如我们前面提到的，PCIe对于PCI的一大升级是从并行总线换成了基于Serdes的多Lane
P2P串行总线。图示如下：</p>
<div class="figure">
<img alt="../_images/pci_vs_pcie.svg" src="../_images/pci_vs_pcie.svg" /></div>
<p>所以PCIe总线和鲲鹏的系统总线不同，它是一个树状的分层架构：</p>
<div class="figure">
<img alt="../_images/pcie_arch.svg" src="../_images/pcie_arch.svg" /></div>
<p>其中的RC是一个虚拟的概念，相当于软件对于PCI设备访问的一个抽象，实现相关，之后是
链接出去的独立的终点（EP，End Point）或者网桥，网桥复制这个结构，就形成整个网络
了。</p>
<p>这样的网络结构在理解上反而相对简单，不会像PCI总线那样，每个高层语义都要转化为物
理信号。PCIe的高层语义直接可以建立在通讯语义的基础上。这个协议上分成三层：</p>
<ul class="simple">
<li>会话层：定义总线不同业务，比如内存/IO访问，中断，低功耗处理等的通讯和消息协议</li>
<li>数据链路层：定义会话，链路，通道等协议</li>
<li>物理层：定义Serdes层的协议要求</li>
</ul>
<p>用户能感知的是会话层，直接决定功能。数据链路层，对使用者的感知呈现为对设备QoS的
控制，通过配置总线属性来访问。而物理层，基本上对用户不可见。</p>
<p>正因为这样一个架构，鲲鹏920的片内设备很容易就封装为会话层接口，对软件提供PCIe的
设备语义。有些协议，比如CCIX，可以工作在PCIe的数据链路层上，替换了会话层，只要
修改一下PCIe控制器的工作模式，就可以让部分端口工作在CCIX模式上了。</p>
<div class="section" id="id2">
<h3>地址空间<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h3>
<p>前面说过，PCI/PCIe的最大特点是提供了系统总线一样的语义，可以直接通过地址访问直
接访问每个设备。</p>
<p>但对于PCIe总线，这个问题比一般的系统总线设备会复杂得多。系统总线是固定的，有多
少设备一开始就可以知道，配合DAW机制，我们可以给每个设备固定的地址空间。而对于
PCIe的网桥，我们可以给它一个地址空间。但当数据发到这个网桥本身的时候，它怎么知
道这个数据属于下属的哪个设备或者哪个网桥呢？</p>
<p>这涉及PCIe总线控制器的枚举过程，BIOS或者OS在使用PCIE设备前，需要扫描整个总线结
构，找到每个通讯节点，给它指定地址，这样未来再发地址请求过来，PCIe的设备和网桥
就知道如何处理这个地址了。</p>
<p>PCIe控制器支持三种地址：</p>
<ul class="simple">
<li>配置地址，这在PCI标准中称为配置空间，在PCIe中作了扩展，称为ECAM空间，Enhanced
Configuration Access echanism。在本文中，在不会引起误会的情况下，我们混用这两
个概念，两者是兼容的。</li>
<li>内存地址，这个访问的可能是内存，也可能是MMIO</li>
<li>IO地址，这个是为了兼容传统有独立IO访问指令的处理器设计的。</li>
</ul>
<p>前面我们说过，早期的CPU常常用不同的指令访问内存和IO。新的处理器就只用MMIO，内存
和IO是统一编址的。但PCIe兼容PCI，还支持传统的IO地址。所以这里的三个地址其实有三
种地址方式，其中配置地址可以映射为IO空间的地址，或者MMIO空间的地址，在鲲鹏中，
主要就是MMIO的地址。而内存地址主要就是指总线的物理地址。而IO地址，需要CPU中用io
指令发出这样的请求。在鲲鹏中，会把这个地址空间映射为一段MMIO的空间。</p>
<p>下面是使用鲲鹏920的泰山服务器Linux 5.0内核启动时打印的IO空间对内存空间的映射：:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Remapped</span> <span class="n">I</span><span class="o">/</span><span class="n">O</span> <span class="mh">0x00000000efff0000</span> <span class="n">to</span> <span class="p">[</span><span class="n">io</span>  <span class="mh">0x0000</span><span class="o">-</span><span class="mh">0xffff</span> <span class="n">window</span><span class="p">]</span>
<span class="n">Remapped</span> <span class="n">I</span><span class="o">/</span><span class="n">O</span> <span class="mh">0x00000000ffff0000</span> <span class="n">to</span> <span class="p">[</span><span class="n">io</span>  <span class="mh">0x10000</span><span class="o">-</span><span class="mh">0x1ffff</span> <span class="n">window</span><span class="p">]</span>
</pre></div>
</div>
<p>代码在drivers/acpi/pci_root.c:acpi_pci_root_remap_iospace()中。它从ACPI的配置表
中得到对应的物理空间，映射到内核虚拟空间中，以便在设备要求用IO的方式访问的时候
可以通过MMIO访问这个虚拟地址空间实现对应的IO请求。</p>
<p>ECAM空间是分配给PCIe控制器的物理地址的一部分，系统可以选择有一个或者多个ECAM空
间。</p>
<p>下面是使用鲲鹏920的泰山服务器Linux 5.0内核启动时打印的所有ECAM空间：:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">acpi</span> <span class="n">PNP0A08</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span> <span class="n">ECAM</span> <span class="n">at</span> <span class="p">[</span><span class="n">mem</span> <span class="mh">0xd0000000</span><span class="o">-</span><span class="mh">0xd3ffffff</span><span class="p">]</span> <span class="k">for</span> <span class="p">[</span><span class="n">bus</span> <span class="mi">00</span><span class="o">-</span><span class="mi">3</span><span class="n">f</span><span class="p">]</span>
<span class="n">acpi</span> <span class="n">PNP0A08</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span> <span class="n">ECAM</span> <span class="n">at</span> <span class="p">[</span><span class="n">mem</span> <span class="mh">0xd7b00000</span><span class="o">-</span><span class="mh">0xd7bfffff</span><span class="p">]</span> <span class="k">for</span> <span class="p">[</span><span class="n">bus</span> <span class="mi">7</span><span class="n">b</span><span class="p">]</span>
<span class="n">acpi</span> <span class="n">PNP0A08</span><span class="p">:</span><span class="mi">02</span><span class="p">:</span> <span class="n">ECAM</span> <span class="n">at</span> <span class="p">[</span><span class="n">mem</span> <span class="mh">0xd7a00000</span><span class="o">-</span><span class="mh">0xd7afffff</span><span class="p">]</span> <span class="k">for</span> <span class="p">[</span><span class="n">bus</span> <span class="mi">7</span><span class="n">a</span><span class="p">]</span>
<span class="n">acpi</span> <span class="n">PNP0A08</span><span class="p">:</span><span class="mi">03</span><span class="p">:</span> <span class="n">ECAM</span> <span class="n">at</span> <span class="p">[</span><span class="n">mem</span> <span class="mh">0xd7800000</span><span class="o">-</span><span class="mh">0xd79fffff</span><span class="p">]</span> <span class="k">for</span> <span class="p">[</span><span class="n">bus</span> <span class="mi">78</span><span class="o">-</span><span class="mi">79</span><span class="p">]</span>
<span class="n">acpi</span> <span class="n">PNP0A08</span><span class="p">:</span><span class="mi">04</span><span class="p">:</span> <span class="n">ECAM</span> <span class="n">at</span> <span class="p">[</span><span class="n">mem</span> <span class="mh">0xd7c00000</span><span class="o">-</span><span class="mh">0xd7dfffff</span><span class="p">]</span> <span class="k">for</span> <span class="p">[</span><span class="n">bus</span> <span class="mi">7</span><span class="n">c</span><span class="o">-</span><span class="mi">7</span><span class="n">d</span><span class="p">]</span>
<span class="n">acpi</span> <span class="n">PNP0A08</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span> <span class="n">ECAM</span> <span class="n">at</span> <span class="p">[</span><span class="n">mem</span> <span class="mh">0xd7400000</span><span class="o">-</span><span class="mh">0xd76fffff</span><span class="p">]</span> <span class="k">for</span> <span class="p">[</span><span class="n">bus</span> <span class="mi">74</span><span class="o">-</span><span class="mi">76</span><span class="p">]</span>
<span class="n">acpi</span> <span class="n">PNP0A08</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span> <span class="n">ECAM</span> <span class="n">at</span> <span class="p">[</span><span class="n">mem</span> <span class="mh">0xd8000000</span><span class="o">-</span><span class="mh">0xd9ffffff</span><span class="p">]</span> <span class="k">for</span> <span class="p">[</span><span class="n">bus</span> <span class="mi">80</span><span class="o">-</span><span class="mi">9</span><span class="n">f</span><span class="p">]</span>
<span class="n">acpi</span> <span class="n">PNP0A08</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span> <span class="n">ECAM</span> <span class="n">at</span> <span class="p">[</span><span class="n">mem</span> <span class="mh">0xdbb00000</span><span class="o">-</span><span class="mh">0xdbbfffff</span><span class="p">]</span> <span class="k">for</span> <span class="p">[</span><span class="n">bus</span> <span class="n">bb</span><span class="p">]</span>
<span class="n">acpi</span> <span class="n">PNP0A08</span><span class="p">:</span><span class="mi">08</span><span class="p">:</span> <span class="n">ECAM</span> <span class="n">at</span> <span class="p">[</span><span class="n">mem</span> <span class="mh">0xdba00000</span><span class="o">-</span><span class="mh">0xdbafffff</span><span class="p">]</span> <span class="k">for</span> <span class="p">[</span><span class="n">bus</span> <span class="n">ba</span><span class="p">]</span>
<span class="n">acpi</span> <span class="n">PNP0A08</span><span class="p">:</span><span class="mi">09</span><span class="p">:</span> <span class="n">ECAM</span> <span class="n">at</span> <span class="p">[</span><span class="n">mem</span> <span class="mh">0xdb800000</span><span class="o">-</span><span class="mh">0xdb9fffff</span><span class="p">]</span> <span class="k">for</span> <span class="p">[</span><span class="n">bus</span> <span class="n">b8</span><span class="o">-</span><span class="n">b9</span><span class="p">]</span>
<span class="n">acpi</span> <span class="n">PNP0A08</span><span class="p">:</span><span class="mi">0</span><span class="n">a</span><span class="p">:</span> <span class="n">ECAM</span> <span class="n">at</span> <span class="p">[</span><span class="n">mem</span> <span class="mh">0xdbc00000</span><span class="o">-</span><span class="mh">0xdbdfffff</span><span class="p">]</span> <span class="k">for</span> <span class="p">[</span><span class="n">bus</span> <span class="n">bc</span><span class="o">-</span><span class="n">bd</span><span class="p">]</span>
<span class="n">acpi</span> <span class="n">PNP0A08</span><span class="p">:</span><span class="mi">0</span><span class="n">b</span><span class="p">:</span> <span class="n">ECAM</span> <span class="n">at</span> <span class="p">[</span><span class="n">mem</span> <span class="mh">0xdb400000</span><span class="o">-</span><span class="mh">0xdb6fffff</span><span class="p">]</span> <span class="k">for</span> <span class="p">[</span><span class="n">bus</span> <span class="n">b4</span><span class="o">-</span><span class="n">b6</span><span class="p">]</span>
</pre></div>
</div>
<p>注意了，这个看起来包含了多个ECAM空间，其实只是一个配置空间，这个空间的首地址在
0xd0000000，其他的地址是以Bus ID为区分的，比如PNP0A08:01的总线是7b，它的配置空间
首地址就在0xd0000000+0x7b00000的位置上。</p>
<p>PCIe控制器先用ECAM空间来保证CPU可以找到每个设备，然后再配置每个设备的其他地址。
为了从ECAM中定位到设备，从PCI开始就引入了一个Bus-Device-Function的概念，用来区
分地址上的不同设备：</p>
<ul class="simple">
<li>Bus：总线编号，用于唯一标识系统中的总线</li>
<li>Device：EP的编号，用于标识一个网桥上的一个设备</li>
<li>Function：EP内一个独立的功能的编号，这用于一个硬件有多个功能的情形，比如一张
同时支持Ethernet和RoCE的网卡，就包含两个Function了。</li>
</ul>
<p>Bus-Device-Function简称BDF，可以唯一定位一个设备，一般用b:d.f这种格式表示。把
BDF和ECAM的首地址组合起来，我们就可以组成一个地址，用于唯一定位一个设备的配置空
间：</p>
<div class="figure">
<img alt="../_images/ecam_address.svg" src="../_images/ecam_address.svg" /></div>
<p>所以，如果我们知道BDF，和ECAM的首地址，我们就可以访问一个设备的配置空间——如果这
个设备存在的话。</p>
<p>我们用PCIe的一个例子看看具体的BDF是如何指配的。下图给出这样一个示例：</p>
<div class="figure">
<img alt="../_images/pci_bus_id_allocation.svg" src="../_images/pci_bus_id_allocation.svg" /></div>
<p>由于PCIe是个P2P的总线，网桥内部实际是报文的重新调度，而没有原来PCI总线的意义了
，PCIe标准虚拟化地认为总线仍是存在的，网桥内部包含多个总线控制器。而控制器也是
一个设备，这个设备的上游总线称为Primary Bus，下游总线称为Secondary Bus。</p>
<p>这样网桥内部其实可以认为包含了一条Secondary Bus和多个总线控制器，虽然其实物理上
它只是多个端口之间的调度。这样，基于ECAM空间加上BDF，我们总是可以试验出所有可以
访问的设备的。下面是这个过程的一个示例：</p>
<ol class="arabic simple">
<li>扫描程序访问0:0.0，0:1.0, 0:2.0……的配置空间，看能否读到其中的Vendor寄存器，
这样我们就可以刺探到这个设备是否真实存在。如果设备存在，而且类型是个EP，这个
设备就找到了。如果这个设备又是一个总线控制器，我们进入总线设置的过程。</li>
<li>假设这个总线控制器的BDF=0:x.0，根据约定，我们设置它的Primary是0，Secondary
是我们要指派的总线号，我们分配1给它，我们就又得到一个总线1，我们可以用第一步
一样的方法扫描1:0.0, 1:1.0, 1:2.0……得到这条总线上的设备或者总线控制器。</li>
<li>等我们深度优先扫描完一条总线，我们也知道每个网桥的Sub Ordinary应该是多少了，
把这个结果配置上，我们就得到这个根桥中所有总线对象的配置空间的地址了。之后的
问题是怎么访问这些空间的问题而已。</li>
</ol>
<p>配置空间的格式如下：</p>
<div class="figure">
<img alt="../_images/pci_config_space.svg" src="../_images/pci_config_space.svg" /></div>
<p>PCI和PCIE对每个配置空间预留的大小是不同的，但它们的头部都是一样的。</p>
<p>扫描的过程通常由BIOS和OS共同完成。BIOS可以是要进行第一轮扫描和指配的，否则它无
法找到相关的设备完成启动过程。比如如果启动设备挂在PCIe总线上，BIOS不做这个扫描
就无法完成启动过程。但进入OS后，OS不一定会认可这个扫描结果，它可能全部或者部分
重新扫描，这都和具体的设计相关。</p>
<p>除了ECAM空间，现在只剩下设备本身的IO地址或者MMIO地址问题了。由于我们已经有了所
有设备和网桥的配置空间，只要软件对分配给这个总线控制器的物理空间进行分配，然后
写到对应设备的BAR寄存器（Base Address Register）中即可。而网桥则需要配置哪部分
地址需要下发给它的下游，就可以支持这个通讯。</p>
<p>要注意的是，地址请求不但可以从PCIe空间之外的其他设备发起，也可以从PCIe空间之内
的设备发起。</p>
</div>
</div>
<div class="section" id="id3">
<h2>鲲鹏920的实际和虚拟PCIe接口<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h2>
<p>鲲鹏的920的每个SICL中包含一个PCI_ICL提供PCIe控制器，同时在每个主要的片上设备中
嵌入PEH和PBU提供PCIe的会话层响应，从总线访问接口看来，这些设备都连在同一个RC上
。</p>
<p>鲲鹏920在每个ICL中内置了一些PEH或者PBU单元，在会话层提供PCIe的配置和访问语义。</p>
<blockquote>
<div><div class="line-block">
<div class="line">PEH</div>
<div class="line">PCI Endpoint Header，是嵌入到每个鲲鹏920内部设备上的PCI EP模拟单元</div>
</div>
<div class="line-block">
<div class="line">PBU</div>
<div class="line">PCI Bridge Unit，是嵌入到鲲鹏920内部设备中用于模拟PCI网桥的单元</div>
</div>
</div></blockquote>
<p>这个原理图示如下：</p>
<div class="figure">
<img alt="../_images/kp920_pci_vpci_arch.svg" src="../_images/kp920_pci_vpci_arch.svg" /></div>
<p>整个系统构成一个单一RC的结构，总线的DAW机制提供第一级的地址控制行为。BIOS配置
DAW把各个根桥的地址分配到不同的Station上，之后不同的地址空间就可以走到不同的设
备上了。</p>
<p>总线地址完成分配后，在Linux中可以通过lspci看到整个分配的过程。比如，下面是一个
插了外置设备的泰山服务器的lspci结果：:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">00</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">PCI</span> <span class="n">bridge</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">HiSilicon</span> <span class="n">PCIe</span> <span class="n">Root</span> <span class="n">Port</span> <span class="k">with</span> <span class="n">Gen4</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">21</span><span class="p">)</span>
<span class="mi">00</span><span class="p">:</span><span class="mf">08.0</span> <span class="n">PCI</span> <span class="n">bridge</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">HiSilicon</span> <span class="n">PCIe</span> <span class="n">Root</span> <span class="n">Port</span> <span class="k">with</span> <span class="n">Gen4</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">21</span><span class="p">)</span>
<span class="mi">00</span><span class="p">:</span><span class="mi">0</span><span class="n">c</span><span class="o">.</span><span class="mi">0</span> <span class="n">PCI</span> <span class="n">bridge</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">HiSilicon</span> <span class="n">PCIe</span> <span class="n">Root</span> <span class="n">Port</span> <span class="k">with</span> <span class="n">Gen4</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">21</span><span class="p">)</span>
<span class="mi">00</span><span class="p">:</span><span class="mf">10.0</span> <span class="n">PCI</span> <span class="n">bridge</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">HiSilicon</span> <span class="n">PCIe</span> <span class="n">Root</span> <span class="n">Port</span> <span class="k">with</span> <span class="n">Gen4</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">21</span><span class="p">)</span>
<span class="mi">00</span><span class="p">:</span><span class="mf">11.0</span> <span class="n">PCI</span> <span class="n">bridge</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">HiSilicon</span> <span class="n">PCIe</span> <span class="n">Root</span> <span class="n">Port</span> <span class="k">with</span> <span class="n">Gen4</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">21</span><span class="p">)</span>
<span class="mi">00</span><span class="p">:</span><span class="mf">12.0</span> <span class="n">PCI</span> <span class="n">bridge</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">HiSilicon</span> <span class="n">PCIe</span> <span class="n">Root</span> <span class="n">Port</span> <span class="k">with</span> <span class="n">Gen4</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">21</span><span class="p">)</span>
<span class="mi">01</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">Ethernet</span> <span class="n">controller</span><span class="p">:</span> <span class="n">Intel</span> <span class="n">Corporation</span> <span class="mi">82599</span><span class="n">ES</span> <span class="mi">10</span><span class="o">-</span><span class="n">Gigabit</span> <span class="n">SFI</span><span class="o">/</span><span class="n">SFP</span><span class="o">+</span> <span class="n">Network</span> <span class="n">Connection</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">01</span><span class="p">)</span>
<span class="mi">01</span><span class="p">:</span><span class="mf">00.1</span> <span class="n">Ethernet</span> <span class="n">controller</span><span class="p">:</span> <span class="n">Intel</span> <span class="n">Corporation</span> <span class="mi">82599</span><span class="n">ES</span> <span class="mi">10</span><span class="o">-</span><span class="n">Gigabit</span> <span class="n">SFI</span><span class="o">/</span><span class="n">SFP</span><span class="o">+</span> <span class="n">Network</span> <span class="n">Connection</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">01</span><span class="p">)</span>
<span class="mi">02</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">RAID</span> <span class="n">bus</span> <span class="n">controller</span><span class="p">:</span> <span class="n">LSI</span> <span class="n">Logic</span> <span class="o">/</span> <span class="n">Symbios</span> <span class="n">Logic</span> <span class="n">MegaRAID</span> <span class="n">Tri</span><span class="o">-</span><span class="n">Mode</span> <span class="n">SAS3508</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">01</span><span class="p">)</span>
<span class="mi">03</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">Ethernet</span> <span class="n">controller</span><span class="p">:</span> <span class="n">Intel</span> <span class="n">Corporation</span> <span class="n">I350</span> <span class="n">Gigabit</span> <span class="n">Network</span> <span class="n">Connection</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">01</span><span class="p">)</span>
<span class="mi">03</span><span class="p">:</span><span class="mf">00.1</span> <span class="n">Ethernet</span> <span class="n">controller</span><span class="p">:</span> <span class="n">Intel</span> <span class="n">Corporation</span> <span class="n">I350</span> <span class="n">Gigabit</span> <span class="n">Network</span> <span class="n">Connection</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">01</span><span class="p">)</span>
<span class="mi">03</span><span class="p">:</span><span class="mf">00.2</span> <span class="n">Ethernet</span> <span class="n">controller</span><span class="p">:</span> <span class="n">Intel</span> <span class="n">Corporation</span> <span class="n">I350</span> <span class="n">Gigabit</span> <span class="n">Network</span> <span class="n">Connection</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">01</span><span class="p">)</span>
<span class="mi">03</span><span class="p">:</span><span class="mf">00.3</span> <span class="n">Ethernet</span> <span class="n">controller</span><span class="p">:</span> <span class="n">Intel</span> <span class="n">Corporation</span> <span class="n">I350</span> <span class="n">Gigabit</span> <span class="n">Network</span> <span class="n">Connection</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">01</span><span class="p">)</span>
<span class="mi">04</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">Signal</span> <span class="n">processing</span> <span class="n">controller</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">iBMA</span> <span class="n">Virtual</span> <span class="n">Network</span> <span class="n">Adapter</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">01</span><span class="p">)</span>
<span class="mi">05</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">VGA</span> <span class="n">compatible</span> <span class="n">controller</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">Hi1710</span> <span class="p">[</span><span class="n">iBMC</span> <span class="n">Intelligent</span> <span class="n">Management</span> <span class="n">system</span> <span class="n">chip</span> <span class="n">w</span><span class="o">/</span><span class="n">VGA</span> <span class="n">support</span><span class="p">]</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">01</span><span class="p">)</span>
<span class="mi">74</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">PCI</span> <span class="n">bridge</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">HiSilicon</span> <span class="n">PCI</span><span class="o">-</span><span class="n">PCI</span> <span class="n">Bridge</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">20</span><span class="p">)</span>
<span class="mi">74</span><span class="p">:</span><span class="mf">01.0</span> <span class="n">PCI</span> <span class="n">bridge</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">HiSilicon</span> <span class="n">PCI</span><span class="o">-</span><span class="n">PCI</span> <span class="n">Bridge</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">20</span><span class="p">)</span>
<span class="mi">74</span><span class="p">:</span><span class="mf">02.0</span> <span class="n">Serial</span> <span class="n">Attached</span> <span class="n">SCSI</span> <span class="n">controller</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">HiSilicon</span> <span class="n">SAS</span> <span class="mf">3.0</span> <span class="n">HBA</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">21</span><span class="p">)</span>
<span class="mi">74</span><span class="p">:</span><span class="mf">03.0</span> <span class="n">SATA</span> <span class="n">controller</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">HiSilicon</span> <span class="n">AHCI</span> <span class="n">HBA</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">21</span><span class="p">)</span>
<span class="mi">74</span><span class="p">:</span><span class="mf">04.0</span> <span class="n">Serial</span> <span class="n">Attached</span> <span class="n">SCSI</span> <span class="n">controller</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">HiSilicon</span> <span class="n">SAS</span> <span class="mf">3.0</span> <span class="n">HBA</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">21</span><span class="p">)</span>
<span class="mi">75</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">Processing</span> <span class="n">accelerators</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">HiSilicon</span> <span class="n">ZIP</span> <span class="n">Engine</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">21</span><span class="p">)</span>
<span class="mi">76</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">Network</span> <span class="ow">and</span> <span class="n">computing</span> <span class="n">encryption</span> <span class="n">device</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">HiSilicon</span> <span class="n">SEC</span> <span class="n">Engine</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">21</span><span class="p">)</span>
<span class="mi">78</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">PCI</span> <span class="n">bridge</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">HiSilicon</span> <span class="n">PCI</span><span class="o">-</span><span class="n">PCI</span> <span class="n">Bridge</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">20</span><span class="p">)</span>
<span class="mi">78</span><span class="p">:</span><span class="mf">01.0</span> <span class="n">RAID</span> <span class="n">bus</span> <span class="n">controller</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">HiSilicon</span> <span class="n">RDE</span> <span class="n">Engine</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">21</span><span class="p">)</span>
<span class="mi">79</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">Network</span> <span class="ow">and</span> <span class="n">computing</span> <span class="n">encryption</span> <span class="n">device</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">HiSilicon</span> <span class="n">HPRE</span> <span class="n">Engine</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">21</span><span class="p">)</span>
<span class="mi">7</span><span class="n">a</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">USB</span> <span class="n">controller</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">Device</span> <span class="n">a23b</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">21</span><span class="p">)</span>
<span class="mi">7</span><span class="n">a</span><span class="p">:</span><span class="mf">01.0</span> <span class="n">USB</span> <span class="n">controller</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">HiSilicon</span> <span class="n">USB</span> <span class="mf">2.0</span> <span class="mi">2</span><span class="o">-</span><span class="n">port</span> <span class="n">Host</span> <span class="n">Controller</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">21</span><span class="p">)</span>
<span class="mi">7</span><span class="n">a</span><span class="p">:</span><span class="mf">02.0</span> <span class="n">USB</span> <span class="n">controller</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">HiSilicon</span> <span class="n">USB</span> <span class="mf">3.0</span> <span class="n">Host</span> <span class="n">Controller</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">21</span><span class="p">)</span>
<span class="mi">7</span><span class="n">b</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">System</span> <span class="n">peripheral</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">HiSilicon</span> <span class="n">Embedded</span> <span class="n">DMA</span> <span class="n">Engine</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">21</span><span class="p">)</span>
<span class="mi">7</span><span class="n">c</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">PCI</span> <span class="n">bridge</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">HiSilicon</span> <span class="n">PCI</span><span class="o">-</span><span class="n">PCI</span> <span class="n">Bridge</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">20</span><span class="p">)</span>
<span class="mi">7</span><span class="n">d</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">Ethernet</span> <span class="n">controller</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">HNS</span> <span class="n">GE</span><span class="o">/</span><span class="mi">10</span><span class="n">GE</span><span class="o">/</span><span class="mi">25</span><span class="n">GE</span> <span class="n">RDMA</span> <span class="n">Network</span> <span class="n">Controller</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">21</span><span class="p">)</span>
<span class="mi">7</span><span class="n">d</span><span class="p">:</span><span class="mf">00.1</span> <span class="n">Ethernet</span> <span class="n">controller</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">HNS</span> <span class="n">GE</span><span class="o">/</span><span class="mi">10</span><span class="n">GE</span><span class="o">/</span><span class="mi">25</span><span class="n">GE</span> <span class="n">Network</span> <span class="n">Controller</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">21</span><span class="p">)</span>
<span class="mi">7</span><span class="n">d</span><span class="p">:</span><span class="mf">00.2</span> <span class="n">Ethernet</span> <span class="n">controller</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">HNS</span> <span class="n">GE</span><span class="o">/</span><span class="mi">10</span><span class="n">GE</span><span class="o">/</span><span class="mi">25</span><span class="n">GE</span> <span class="n">RDMA</span> <span class="n">Network</span> <span class="n">Controller</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">21</span><span class="p">)</span>
<span class="mi">7</span><span class="n">d</span><span class="p">:</span><span class="mf">00.3</span> <span class="n">Ethernet</span> <span class="n">controller</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">HNS</span> <span class="n">GE</span><span class="o">/</span><span class="mi">10</span><span class="n">GE</span><span class="o">/</span><span class="mi">25</span><span class="n">GE</span> <span class="n">Network</span> <span class="n">Controller</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">21</span><span class="p">)</span>
<span class="mi">80</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">PCI</span> <span class="n">bridge</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">HiSilicon</span> <span class="n">PCIe</span> <span class="n">Root</span> <span class="n">Port</span> <span class="k">with</span> <span class="n">Gen4</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">21</span><span class="p">)</span>
<span class="mi">80</span><span class="p">:</span><span class="mf">04.0</span> <span class="n">PCI</span> <span class="n">bridge</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">HiSilicon</span> <span class="n">PCIe</span> <span class="n">Root</span> <span class="n">Port</span> <span class="k">with</span> <span class="n">Gen4</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">21</span><span class="p">)</span>
<span class="mi">80</span><span class="p">:</span><span class="mf">08.0</span> <span class="n">PCI</span> <span class="n">bridge</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">HiSilicon</span> <span class="n">PCIe</span> <span class="n">Root</span> <span class="n">Port</span> <span class="k">with</span> <span class="n">Gen4</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">21</span><span class="p">)</span>
<span class="mi">80</span><span class="p">:</span><span class="mi">0</span><span class="n">c</span><span class="o">.</span><span class="mi">0</span> <span class="n">PCI</span> <span class="n">bridge</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">HiSilicon</span> <span class="n">PCIe</span> <span class="n">Root</span> <span class="n">Port</span> <span class="k">with</span> <span class="n">Gen4</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">21</span><span class="p">)</span>
<span class="mi">80</span><span class="p">:</span><span class="mf">10.0</span> <span class="n">PCI</span> <span class="n">bridge</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">HiSilicon</span> <span class="n">PCIe</span> <span class="n">Root</span> <span class="n">Port</span> <span class="k">with</span> <span class="n">Gen4</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">21</span><span class="p">)</span>
<span class="mi">85</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">PCI</span> <span class="n">bridge</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">Hi1822</span> <span class="n">Family</span> <span class="n">Virtual</span> <span class="n">Bridge</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">45</span><span class="p">)</span>
<span class="mi">86</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">PCI</span> <span class="n">bridge</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">Hi1822</span> <span class="n">Family</span> <span class="n">Virtual</span> <span class="n">Bridge</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">45</span><span class="p">)</span>
<span class="mi">86</span><span class="p">:</span><span class="mf">01.0</span> <span class="n">PCI</span> <span class="n">bridge</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">Hi1822</span> <span class="n">Family</span> <span class="n">Virtual</span> <span class="n">Bridge</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">45</span><span class="p">)</span>
<span class="mi">86</span><span class="p">:</span><span class="mf">02.0</span> <span class="n">PCI</span> <span class="n">bridge</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">Hi1822</span> <span class="n">Family</span> <span class="n">Virtual</span> <span class="n">Bridge</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">45</span><span class="p">)</span>
<span class="mi">86</span><span class="p">:</span><span class="mf">03.0</span> <span class="n">PCI</span> <span class="n">bridge</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">Hi1822</span> <span class="n">Family</span> <span class="n">Virtual</span> <span class="n">Bridge</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">45</span><span class="p">)</span>
<span class="mi">87</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">Ethernet</span> <span class="n">controller</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">Hi1822</span> <span class="n">Family</span> <span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="mi">25</span><span class="n">GE</span><span class="p">)</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">45</span><span class="p">)</span>
<span class="mi">88</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">Ethernet</span> <span class="n">controller</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">Hi1822</span> <span class="n">Family</span> <span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="mi">25</span><span class="n">GE</span><span class="p">)</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">45</span><span class="p">)</span>
<span class="mi">89</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">Ethernet</span> <span class="n">controller</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">Hi1822</span> <span class="n">Family</span> <span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="mi">25</span><span class="n">GE</span><span class="p">)</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">45</span><span class="p">)</span>
<span class="mi">8</span><span class="n">a</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">Ethernet</span> <span class="n">controller</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">Hi1822</span> <span class="n">Family</span> <span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="mi">25</span><span class="n">GE</span><span class="p">)</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">45</span><span class="p">)</span>
<span class="n">b4</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">PCI</span> <span class="n">bridge</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">HiSilicon</span> <span class="n">PCI</span><span class="o">-</span><span class="n">PCI</span> <span class="n">Bridge</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">20</span><span class="p">)</span>
<span class="n">b4</span><span class="p">:</span><span class="mf">01.0</span> <span class="n">PCI</span> <span class="n">bridge</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">HiSilicon</span> <span class="n">PCI</span><span class="o">-</span><span class="n">PCI</span> <span class="n">Bridge</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">20</span><span class="p">)</span>
<span class="n">b4</span><span class="p">:</span><span class="mf">02.0</span> <span class="n">Serial</span> <span class="n">Attached</span> <span class="n">SCSI</span> <span class="n">controller</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">HiSilicon</span> <span class="n">SAS</span> <span class="mf">3.0</span> <span class="n">HBA</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">21</span><span class="p">)</span>
<span class="n">b4</span><span class="p">:</span><span class="mf">03.0</span> <span class="n">SATA</span> <span class="n">controller</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">HiSilicon</span> <span class="n">AHCI</span> <span class="n">HBA</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">21</span><span class="p">)</span>
<span class="n">b4</span><span class="p">:</span><span class="mf">04.0</span> <span class="n">Serial</span> <span class="n">Attached</span> <span class="n">SCSI</span> <span class="n">controller</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">HiSilicon</span> <span class="n">SAS</span> <span class="mf">3.0</span> <span class="n">HBA</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">21</span><span class="p">)</span>
<span class="n">b5</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">Processing</span> <span class="n">accelerators</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">HiSilicon</span> <span class="n">ZIP</span> <span class="n">Engine</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">21</span><span class="p">)</span>
<span class="n">b6</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">Network</span> <span class="ow">and</span> <span class="n">computing</span> <span class="n">encryption</span> <span class="n">device</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">HiSilicon</span> <span class="n">SEC</span> <span class="n">Engine</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">21</span><span class="p">)</span>
<span class="n">b8</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">PCI</span> <span class="n">bridge</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">HiSilicon</span> <span class="n">PCI</span><span class="o">-</span><span class="n">PCI</span> <span class="n">Bridge</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">20</span><span class="p">)</span>
<span class="n">b8</span><span class="p">:</span><span class="mf">01.0</span> <span class="n">RAID</span> <span class="n">bus</span> <span class="n">controller</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">HiSilicon</span> <span class="n">RDE</span> <span class="n">Engine</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">21</span><span class="p">)</span>
<span class="n">b9</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">Network</span> <span class="ow">and</span> <span class="n">computing</span> <span class="n">encryption</span> <span class="n">device</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">HiSilicon</span> <span class="n">HPRE</span> <span class="n">Engine</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">21</span><span class="p">)</span>
<span class="n">bb</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">System</span> <span class="n">peripheral</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">HiSilicon</span> <span class="n">Embedded</span> <span class="n">DMA</span> <span class="n">Engine</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">21</span><span class="p">)</span>
<span class="n">bc</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">PCI</span> <span class="n">bridge</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">HiSilicon</span> <span class="n">PCI</span><span class="o">-</span><span class="n">PCI</span> <span class="n">Bridge</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">20</span><span class="p">)</span>
<span class="n">bd</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">Ethernet</span> <span class="n">controller</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">HNS</span> <span class="n">GE</span><span class="o">/</span><span class="mi">10</span><span class="n">GE</span><span class="o">/</span><span class="mi">25</span><span class="n">GE</span> <span class="n">RDMA</span> <span class="n">Network</span> <span class="n">Controller</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">21</span><span class="p">)</span>
<span class="n">bd</span><span class="p">:</span><span class="mf">00.1</span> <span class="n">Ethernet</span> <span class="n">controller</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">HNS</span> <span class="n">GE</span><span class="o">/</span><span class="mi">10</span><span class="n">GE</span><span class="o">/</span><span class="mi">25</span><span class="n">GE</span> <span class="n">Network</span> <span class="n">Controller</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">21</span><span class="p">)</span>
<span class="n">bd</span><span class="p">:</span><span class="mf">00.2</span> <span class="n">Ethernet</span> <span class="n">controller</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">HNS</span> <span class="n">GE</span><span class="o">/</span><span class="mi">10</span><span class="n">GE</span><span class="o">/</span><span class="mi">25</span><span class="n">GE</span> <span class="n">RDMA</span> <span class="n">Network</span> <span class="n">Controller</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">21</span><span class="p">)</span>
<span class="n">bd</span><span class="p">:</span><span class="mf">00.3</span> <span class="n">Ethernet</span> <span class="n">controller</span><span class="p">:</span> <span class="n">Huawei</span> <span class="n">Technologies</span> <span class="n">Co</span><span class="o">.</span><span class="p">,</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">HNS</span> <span class="n">GE</span><span class="o">/</span><span class="mi">10</span><span class="n">GE</span><span class="o">/</span><span class="mi">25</span><span class="n">GE</span> <span class="n">Network</span> <span class="n">Controller</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">21</span><span class="p">)</span>
</pre></div>
</div>
<p>把它绘制成一个完整的连接图，就是这样的：</p>
<div class="figure">
<img alt="../_images/taishan920_bus_id_example.svg" src="../_images/taishan920_bus_id_example.svg" /></div>
<p>可以看到两个不同的SICL构成了两个NUMA域，PCI0和6是真正的PCIe端口，连接外部设备，
其他的外设，以ICL单位，连入不同的根桥。</p>
</div>
<div class="section" id="id4">
<h2>中断处理<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h2>
<p>我们再看看设备中断如何透过PCIe总线进入系统的中断控制系统。前面我们提到，传统的
中断其实是信号线上的电平变化。在PCI的时代，中断</p>
</div>
<div class="section" id="io">
<h2>IO虚拟化<a class="headerlink" href="#io" title="永久链接至标题">¶</a></h2>
<p>todo</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="管理系统.html" class="btn btn-neutral float-right" title="管理系统" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="中断.html" class="btn btn-neutral float-left" title="中断" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Kenneth Lee

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>