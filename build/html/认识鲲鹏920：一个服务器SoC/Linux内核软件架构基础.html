

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="zh-CN" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="zh-CN" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Linux内核软件架构基础 &mdash; 从鲲鹏920了解现代服务器实现和应用 0.1a1 文档</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script type="text/javascript" src="../_static/translations.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
    <link rel="next" title="地址空间" href="地址空间.html" />
    <link rel="prev" title="软件架构" href="软件构架.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> 从鲲鹏920了解现代服务器实现和应用
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../序.html">序</a></li>
<li class="toctree-l1"><a class="reference internal" href="../感谢.html">感谢</a></li>
<li class="toctree-l1"><a class="reference internal" href="../认识服务器/index.html">认识服务器</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">认识鲲鹏920：一个服务器SoC</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="综述.html">综述</a></li>
<li class="toctree-l2"><a class="reference internal" href="总线.html">总线</a></li>
<li class="toctree-l2"><a class="reference internal" href="软件构架.html">软件架构</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Linux内核软件架构基础</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">介绍</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">汇编初始化过程</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">运行参数</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id4">多核支持逻辑</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id5">动态模块</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id6">驱动框架</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id7">内核对象树</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="地址空间.html">地址空间</a></li>
<li class="toctree-l2"><a class="reference internal" href="Cache.html">Cache</a></li>
<li class="toctree-l2"><a class="reference internal" href="Cache.html#cache-coherency">Cache Coherency</a></li>
<li class="toctree-l2"><a class="reference internal" href="中断.html">中断</a></li>
<li class="toctree-l2"><a class="reference internal" href="设备和设备总线.html">设备和设备总线</a></li>
<li class="toctree-l2"><a class="reference internal" href="管理系统.html">管理系统</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../计算子系统/index.html">计算子系统</a></li>
<li class="toctree-l1"><a class="reference internal" href="../网络子系统/index.html">网络子系统</a></li>
<li class="toctree-l1"><a class="reference internal" href="../存储子系统/index.html">存储子系统</a></li>
<li class="toctree-l1"><a class="reference internal" href="../RAS设计/index.html">RAS设计</a></li>
<li class="toctree-l1"><a class="reference internal" href="../未来展望.html">未来展望</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">从鲲鹏920了解现代服务器实现和应用</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">认识鲲鹏920：一个服务器SoC</a> &raquo;</li>
        
      <li>Linux内核软件架构基础</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/认识鲲鹏920：一个服务器SoC/Linux内核软件架构基础.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="linux">
<h1>Linux内核软件架构基础<a class="headerlink" href="#linux" title="永久链接至标题">¶</a></h1>
<div class="section" id="id1">
<h2>介绍<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h2>
<p>本书介绍软件实现实例的时候，主要使用Linux作为例子，所以很多地方都会涉及Linux内
核的实现。我们这里不是写一本关于Linux内核的书，但我们需要和读者建立一个共识，让
读者在一定程度上和我们有对于Linux代码有接近的看法，所以我们在本章介绍一些基本
Linux架构逻辑。</p>
<p>本章的介绍主要以5.5的内核为代码基线，我们尽量聚焦到核心逻辑上，所以相关的逻辑也
可以推广到其他的版本。但如果涉及细节，那就只能针对每个具体的细节版本来说了。这
一点请读者注意。</p>
<p>我们假定读者对GNU/Linux系统的管理和使用有一定的认识，对相关的概念如内存，设备文
件，进程等概念不陌生，也知道如何在Linux上写应用程序。如果知道如何写LKM会更好，
但我们尽量让这一点不是必须的。我们只是尝试让读者用诸如insmod这样的命令的时候，
从逻辑概念上知道背后其实操作系统在干什么。</p>
<p>我们把Linux内核类比为一个Linux上的应用程序。我们平时用C语言在用户态写程序，代码
总是从main开始，但其实编译器在main前面做了更多的准备工作，这部分是汇编写的程序。
Linux Kernel的工作过程和这个用户程序的工作过程没有什么区别。只是用户程序有内核
支持，部分情况下可以进行系统调用寻求内核的支持，而内核必须自己解决大部分问题。
实际上，今天的内核也可以寻求自己的上一层管理软件（比如虚拟机Hypervisor或者安全
管理程序支持）。</p>
<p>所以，我们可以用一个大程序来理解Linux Kernel。它也有自己的汇编入口和C入口。它的
C入口在init/main.c:start_kernel()上。很多的模块链接成一个大程序，start_kernel()
调用每个模块的初始化函数，创建第一个进程（叫init），最后调用do_idle()进程CPU等
待状态，这之后就是等着各种外部刺激激发内核响应不同的操作了。这种刺激可以是：</p>
<ul class="simple">
<li>设备给CPU发中断信号</li>
<li>被调度的进程发起系统调用</li>
</ul>
<p>这个组织形式和我们写一个网络服务程序，创建很多线程等待客户端请求，然后主程序进
入Idle等待的运行结束的模型是一样的。</p>
<p>下面我们分主题给出一些在后面的讨论中可以会涉及的公共概念，以便读者在阅读具体的
章节的时候和我们有接近的认识。这些主题不是Linux内核主题的全部，只是我们选择的，
认为有可能对读者后续认识有帮助的一个个相对独立的逻辑。</p>
</div>
<div class="section" id="id2">
<h2>汇编初始化过程<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h2>
<p>部分读者不一定关心，但我们仍说明一下汇编的初始化过程。和普通程序一样，大部分时
候Linux内核也是一个ELF程序。这个ELF的代码的布局在它的ld script中定义，鲲鹏920作
为通用的ARM服务器，它的ld script就在这里：:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">arch</span><span class="o">/</span><span class="n">arm64</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">vmlinux</span><span class="o">.</span><span class="n">lds</span><span class="o">.</span><span class="n">S</span>
</pre></div>
</div>
<p>从这里我们可以找到它的程序入口：</p>
<div class="highlight-as notranslate"><div class="highlight"><pre><span></span> <span class="nx">ENTRY</span><span class="p">(</span><span class="nx">_text</span><span class="p">)</span>
 <span class="p">...</span>
 <span class="p">.</span><span class="nx">head</span><span class="p">.</span><span class="nx">text</span> <span class="o">:</span> <span class="p">{</span>
         <span class="nx">_text</span> <span class="o">=</span> <span class="p">.;</span>
         <span class="nx">HEAD_TEXT</span>
 <span class="p">}</span>
 <span class="p">...</span>
 <span class="p">.</span><span class="nx">text</span> <span class="o">:</span> <span class="p">{</span>
         <span class="nx">_stext</span> <span class="o">=</span> <span class="p">.;</span>
                 <span class="nx">IRQENTRY_TEXT</span>
                 <span class="nx">SOFTIRQENTRY_TEXT</span>
                 <span class="nx">ENTRY_TEXT</span>
                 <span class="nx">TEXT_TEXT</span>
<span class="p">...</span>
<span class="p">}</span>
<span class="p">...</span>
</pre></div>
</div>
<p>这段定义表明，这个ELF文件的入口地址在_text上，而_text定义为.text段的首地址，而
.text段包含多个子段（部分不存在），……我们忽略这些细节，最后可以找到这个入口：</p>
<blockquote>
<div>arch/arm64/kernel/head.S:_head</div></blockquote>
<p>顺着这个入口走下去，完成最基本的内存准备，最后就会走到这里：</p>
<div class="highlight-as notranslate"><div class="highlight"><pre><span></span>__primary_switched:
        ...
        add     sp, sp, #16
        mov     x29, #0
        mov     x30, #0
        b       start_kernel
ENDPROC(__primary_switched)
</pre></div>
</div>
<p>后面的行为，就是基本的C语言的范畴了。start_kerne就是C程序的主入口。喜欢Hacker
的读者可以在这里增加打印代码来了解内核是怎么工作的。</p>
</div>
<div class="section" id="id3">
<h2>运行参数<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h2>
<p>C的main函数有argc和argv，Linux Kernel使用cmdline作为输入参数，这些参数由
Bootloader负责加载到内存中，通过特定的寄存器告知内核。</p>
<p>在服务器解决方案中，常见的方法是BIOS把Grub作为二级Bootloader进行加载，然后用
Grub加载内核，Grub中就可以给内核指定启动参数。下面是鲲鹏920的一个grub.cfg的配置
片段：:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>menuentry &#39;Ubuntu&#39; --class ubuntu --class gnu-linux --class gnu --class os $menuentry_id_option &#39;gnulinux-simple-8424a46f-56fe-4851-955c-b260f00ad51f&#39; {
        recordfail
        load_video
        gfxmode $linux_gfx_mode
        insmod gzio
        if [ x$grub_platform = xxen ]; then insmod xzio; insmod lzopio; fi
        insmod part_gpt
        insmod ext2
        set root=&#39;hd0,gpt2&#39;
        if [ x$feature_platform_search_hint = xy ]; then
          search --no-floppy --fs-uuid --set=root --hint-ieee1275=&#39;ieee1275//sas/disk@20000,gpt2&#39; --hint-bios=hd0,gpt2 --hint-efi=hd0,gpt2 --hint-baremetal=ahci0,gpt2  8424a46f-56fe-4851-955c-b260f00ad51f
        else
          search --no-floppy --fs-uuid --set=root 8424a46f-56fe-4851-955c-b260f00ad51f
        fi
        linux   /boot/vmlinuz-5.0.0-23-generic root=UUID=8424a46f-56fe-4851-955c-b260f00ad51f ro debug quiet splash $vt_handoff
        initrd  /boot/initrd.img-5.0.0-23-generic
}
</pre></div>
</div>
<p>这些参数在内核中有一个详细的说明文档，在
Documentation/admin-guide/kernel-parameters.txt文件中。内核代码中有专门的代码框
架处理这些参数，读者可以全局搜索__setup()和__setup_param()宏的使用，这个宏的定
义如下：</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define __setup_param(str, unique_id, fn, early)                        \</span>
<span class="cp">        static const char __setup_str_##unique_id[] __initconst         \</span>
<span class="cp">                __aligned(1) = str;                                     \</span>
<span class="cp">        static struct obs_kernel_param __setup_##unique_id              \</span>
<span class="cp">                __used __section(.init.setup)                           \</span>
<span class="cp">                __attribute__((aligned((sizeof(long)))))                \</span>
<span class="cp">                = { __setup_str_##unique_id, fn, early }</span>

<span class="cp">#define __setup(str, fn)                                                \</span>
<span class="cp">        __setup_param(str, fn, fn, 0)</span>
</pre></div>
</div>
<p>其中str是参数的名称，fn是对应的初始化函数。内核初始化流程中有一个比较早期的步骤，
会找到所有的这些定义，回调相应的fn，以完成一些基本的参数设置。</p>
<p>Linux启动以后，可以从/proc/cmdline获得当前使用的命令行参数。</p>
<p>Cmdline提供用户修改Linux内核运行行为的机会，但内核正常运行还需要Bootloader提供
的硬件参数。部分硬件参数可以从硬件寄存器上获得，比如PCI设备就可以通过总线枚举流
程自动发现，但部分硬件才是硬连线决定的，并没有什么太好的方法自动发现出来。这只
能通过Bootloader直接传递。</p>
<p>比较常用的传递参数的方法有Device Tree和ACPI接口。Device Tree是一种NoSQL数据库的
形式，通过一张树状的描述表描述系统中的所有设备和参数，Linux初始化的时候从这个描
述表中读到对应的参数，为部分核心模块提供参数，或者创建设备对象，匹配对应的驱动
从而提供支持。ARM平台支持Device Tree方式访问，并且很多硬件平台把自己的Device
Tree表放在Linux内核中，读者可以从如下目录看到这些定义：:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">arch</span><span class="o">/</span><span class="n">arm64</span><span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">dts</span><span class="o">/</span>
</pre></div>
</div>
<p>为了照顾懒得找机器的读者，我们抄一段在这里提供感性认识：:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">eth0</span><span class="p">:</span> <span class="n">ethernet</span><span class="nd">@4</span><span class="p">{</span>
        <span class="n">compatible</span> <span class="o">=</span> <span class="s2">&quot;hisilicon,hns-nic-v2&quot;</span><span class="p">;</span>
        <span class="n">ae</span><span class="o">-</span><span class="n">handle</span> <span class="o">=</span> <span class="o">&lt;&amp;</span><span class="n">dsaf0</span><span class="o">&gt;</span><span class="p">;</span>
        <span class="n">port</span><span class="o">-</span><span class="n">idx</span><span class="o">-</span><span class="ow">in</span><span class="o">-</span><span class="n">ae</span> <span class="o">=</span> <span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span><span class="p">;</span>
        <span class="n">local</span><span class="o">-</span><span class="n">mac</span><span class="o">-</span><span class="n">address</span> <span class="o">=</span> <span class="p">[</span><span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span><span class="p">];</span>
        <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;disabled&quot;</span><span class="p">;</span>
        <span class="n">dma</span><span class="o">-</span><span class="n">coherent</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>这是鲲鹏920前一代芯片的配置（鲲鹏920不再使用Device Tree）。</p>
<p>Device Tree比较简单直接，但它描述的是一个相对静态的数据结构，比较适合嵌入式系统
，现在Device Tree也能支持Boot Loader动态修改表格结构，但仍不是特别灵活。</p>
<p>作为服务器，鲲鹏920主要使用的是ACPI的接口。ACPI本来是一个用于电源管理的接口标准，
但要做电源管理，就需要描述系统的结构，所以慢慢它就变成了一个描述系统结构的标准
接口了。</p>
<blockquote>
<div><div class="line-block">
<div class="line">ACPI</div>
<div class="line">Advanced Configuration and Power Interface。</div>
<div class="line">ACPI是一个BIOS和OS间的接口标准，它最初的设计目标是让OS有一个标准</div>
<div class="line">的方法请求硬件进入不同的功耗状态。但为了做到这一点，它必须给OS提</div>
<div class="line">供系统包含那些设备等信息，所以最终它就成为一种标准的BIOS和OS交换</div>
<div class="line">数据的接口了。这个接口方法在PC和服务器领域被广泛使用。</div>
</div>
</div></blockquote>
<p>ACPI一大特点是支持AML语言，AML作为一种抽象语言集成在ACPI的数据结构中，由OS一侧
的AML虚拟机解释执行。这样表述能力更强。对比Device Tree，如果你要做复位，Device
Tree只能提供复位要用到的每个寄存器的地址，具体如何复位还是需要OS针对每种不同的
硬件写不同的过程。而用ACPI接口，OS只需要“调用”ACPI表中的复位函数即可，复杂的复
位过程可以封装在ACPI接口表的内部。</p>
<p>下面是鲲鹏920 ACPI DSDT表描述SAS控制器的一个示例（读者可以通过查看对应Boot
Loader的源代码，或者直接在Linux启动后，从/sys/firmware/acpi/tables中找到对应的
表格，然后用isal命令反编译得到这个文件）：:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Device</span> <span class="p">(</span><span class="n">SAS0</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Name</span> <span class="p">(</span><span class="n">_ADR</span><span class="p">,</span> <span class="mh">0x00020000</span><span class="p">)</span>
    <span class="n">Name</span> <span class="p">(</span><span class="n">_DSD</span><span class="p">,</span> <span class="n">Package</span> <span class="p">(</span><span class="mh">0x02</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">ToUUID</span> <span class="p">(</span><span class="s2">&quot;daffd814-6eba-4d8c-8a91-bc9bbf4aa301&quot;</span><span class="p">)</span>
        <span class="n">Package</span> <span class="p">(</span><span class="mh">0x03</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Package</span> <span class="p">(</span><span class="mh">0x02</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="s2">&quot;sas-addr&quot;</span><span class="p">,</span>
                <span class="n">Package</span> <span class="p">(</span><span class="mh">0x08</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="mh">0x50</span><span class="p">,</span>
                    <span class="n">One</span><span class="p">,</span>
                    <span class="mh">0x88</span><span class="p">,</span>
                    <span class="mh">0x20</span><span class="p">,</span>
                    <span class="mh">0x16</span><span class="p">,</span>
                    <span class="n">Zero</span><span class="p">,</span>
                    <span class="n">Zero</span><span class="p">,</span>
                    <span class="n">Zero</span>
                <span class="p">}</span>
            <span class="p">},</span>

            <span class="n">Package</span> <span class="p">(</span><span class="mh">0x02</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="s2">&quot;queue-count&quot;</span><span class="p">,</span>
                <span class="mh">0x10</span>
            <span class="p">},</span>
            <span class="o">...</span>
        <span class="p">}</span>
    <span class="p">})</span>
    <span class="o">...</span>
    <span class="n">Method</span> <span class="p">(</span><span class="n">_RST</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Serialized</span><span class="p">)</span>  <span class="o">//</span> <span class="n">_RST</span><span class="p">:</span> <span class="n">Device</span> <span class="n">Reset</span>
    <span class="p">{</span>
        <span class="n">RST</span> <span class="o">=</span> <span class="mh">0x07FFFFFF</span>
        <span class="n">Sleep</span> <span class="p">(</span><span class="n">One</span><span class="p">)</span>
        <span class="n">DRST</span> <span class="o">=</span> <span class="mh">0x07FFFFFF</span>
        <span class="n">Sleep</span> <span class="p">(</span><span class="n">One</span><span class="p">)</span>
        <span class="n">ST00</span> <span class="o">=</span> <span class="mh">0xAD40</span>
        <span class="n">Sleep</span> <span class="p">(</span><span class="n">One</span><span class="p">)</span>
        <span class="n">ST01</span> <span class="o">=</span> <span class="mh">0xAD40</span>
        <span class="n">Sleep</span> <span class="p">(</span><span class="n">One</span><span class="p">)</span>
        <span class="n">ST02</span> <span class="o">=</span> <span class="mh">0xAD40</span>
        <span class="n">Sleep</span> <span class="p">(</span><span class="n">One</span><span class="p">)</span>
        <span class="o">...</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>其中定义了一个叫_RST的函数，里面是对这个设备进行复位的代码。Linux内部可以通过调
用这个函数实现这个复位。下面是海思SAS驱动的具体操作方式：</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">reset_hw_v3_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">hisi_hba</span> <span class="o">*</span><span class="n">hisi_hba</span><span class="p">)</span>
<span class="p">{</span>
        <span class="p">...</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ACPI_HANDLE</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">acpi_status</span> <span class="n">s</span><span class="p">;</span>

                <span class="n">s</span> <span class="o">=</span> <span class="n">acpi_evaluate_object</span><span class="p">(</span><span class="n">ACPI_HANDLE</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="s">&quot;_RST&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="p">{</span>
                        <span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Reset failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                        <span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no reset method!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>其中acpi_evaluate_object()就实现对_RST函数的调用。</p>
<p>Linux内核对device tree和apci都支持，BIOS传递过来的参数中使能了什么，就用什么。
驱动可以同时支持用两种方式获得参数，也可以支持其中一种。从架构上来说，这总能做
到，如果读者关心细节，可以直接看相关的代码。鲲鹏920前一代Hi1616的网卡驱动，
hns_enet.c，是一个典型的例子，它的probe函数同时判断device tree和acpi的配置，根
据相应的配置进行类似的初始化过程。</p>
<p>在鲲鹏920中，网卡设备都虚拟化为PCIe设备，在它的驱动hns3_enet中，设备参数通过硬
件自动枚举发现，就不需要这些配置了。但非标准的设备，比如SMMU，仍需要通过ACPI或
者Device Tree描述的。</p>
</div>
<div class="section" id="id4">
<h2>多核支持逻辑<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h2>
<p>只了解一般C程序的人不一定能想象多核是怎么工作的。我们可以这样建立这个逻辑：</p>
<ol class="arabic simple">
<li>每个CPU核是独立的，相当于普通程序的main函数（暂时不要考虑多线程）</li>
<li>每个CPU核都可以执行这个main函数。为了让这个过程可控，系统加电的时候，只有一个
核进入运行，其他核都不工作。这样这个核进入main函数后，可以先进行全局的初始化
然后对其他核发复位信号，让那些核也进入main开始运行</li>
<li>所有核共享同一个物理地址空间，但各自有自己的MMU，所有各自有自己的虚拟地址空
间。</li>
<li>核间可以通过给对方发Doorbell（称为IPI，Inter-Processor Interrupt，表现为中断
），对其他核施加影响。</li>
</ol>
<p>所以，其实多核系统的核和核之间是非常独立的，大部分时候都是启动核在内存中分配好
内存，每个核用自己的数据结构完成自己的调度。只有某个核比较闲的时候，才会访问一下
其他核的数据结构，看看能否帮助其他核调度一些线程或者进程，之后，还是按原来的逻辑
在自己的数据结构中一个一个调度分配给它的进程或者中断。</p>
<p>对照到Linux内核的实现。所有核复位后的启动地址都在_stext上。第一个核（0核）启动
后，进行基本的初始化，把每个核都要用的数据在内存中准备好，到start_kernel()的后期
它会创建一个内核线程kernel_init，在kernel_init()一开始调用
kernel_init_freeable()-&gt;smp_init()复位每个其他的核，把它们投入运行。</p>
<p>其他核也从_stext向量进入，根据自己的CPU ID（从系统寄存器中获得），
使用约定的自己的数据结构进行初始化，在鲲鹏920这样ARMv8的兼容平台上，汇编初始化
部分初始化完成后，会进入secondary_start_kernel()作为C语言的入口。之后就是让线程进程
调度器投入等待，直到有线程、进程或者中断调度和本核上来了。</p>
<div class="figure">
<img alt="../_images/multi-core-os-enable.svg" src="../_images/multi-core-os-enable.svg" /></div>
</div>
<div class="section" id="id5">
<h2>动态模块<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h2>
<p>Linux是个很大的程序，下面展示的是使用鲲鹏920的泰山服务器上一个bash进程的大小（
来自这个进程的smaps文件，在/proc/&lt;pid&gt;/smaps中）：:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">aaaaca312000</span><span class="o">-</span><span class="n">aaaaca405000</span> <span class="n">r</span><span class="o">-</span><span class="n">xp</span> <span class="mi">00000000</span> <span class="mi">08</span><span class="p">:</span><span class="mi">02</span> <span class="mi">23592962</span>                   <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="n">aaaaca414000</span><span class="o">-</span><span class="n">aaaaca419000</span> <span class="n">r</span><span class="o">--</span><span class="n">p</span> <span class="mi">000</span><span class="n">f2000</span> <span class="mi">08</span><span class="p">:</span><span class="mi">02</span> <span class="mi">23592962</span>                   <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="n">aaaaca419000</span><span class="o">-</span><span class="n">aaaaca422000</span> <span class="n">rw</span><span class="o">-</span><span class="n">p</span> <span class="mi">000</span><span class="n">f7000</span> <span class="mi">08</span><span class="p">:</span><span class="mi">02</span> <span class="mi">23592962</span>                   <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="o">...</span>
</pre></div>
</div>
<p>忽略其他动态库，这里的r-xp是它的代码段，大小不到1MB。而相同平台上的Linux Kernel
的大小如下（来自内核打印Buffer dmesg）：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Memory</span><span class="p">:</span> <span class="mi">526958844</span><span class="n">K</span><span class="o">/</span><span class="mi">536866688</span><span class="n">K</span> <span class="n">available</span> <span class="p">(</span><span class="mi">12092</span><span class="n">K</span> <span class="n">kernel</span> <span class="n">code</span><span class="p">,</span> <span class="mi">1694</span><span class="n">K</span> <span class="n">rwdata</span><span class="p">,</span> <span class="mi">5112</span><span class="n">K</span> <span class="n">rodata</span><span class="p">,</span> <span class="mi">5504</span><span class="n">K</span> <span class="n">init</span><span class="p">,</span> <span class="mi">1161</span><span class="n">K</span> <span class="n">bss</span><span class="p">,</span> <span class="mi">9875076</span><span class="n">K</span> <span class="n">reserved</span><span class="p">,</span> <span class="mi">32768</span><span class="n">K</span> <span class="n">cma</span><span class="o">-</span><span class="n">reserved</span><span class="p">)</span>
</pre></div>
</div>
<p>代码段的大小是12M。这么大的程序，很多功能其实用不到。Linux就把部分功能做成独立
的模块，动态加载。这种动态加载的模块称为LKM，Linux Kernel Module。在Linux运行
的时候可以通过lsmod命令看到它有那些模块是动态加载的。</p>
<p>LKM的源代码形态中有自己的初始化和反初始化函数，如果在内核编译配置的时候把一个模
块编译为LKM，它就会变独立链接为.ko文件，这个文件被加载到内核中的时候，这个初始
化函数就会被调用，以便这个动态模块可以被注册到内核的其他子系统中，而这个模块被
卸载的时候，它的反初始化函数会被调用，从而脱离那些子系统的注册。</p>
<p>编译者也可以考虑把这些模块编译为内核的一部分，这些模块就不需要动态加载，而是在内
核完成核心系统的初始化后，统一调用他们的初始化函数。这就和一个普通的C程序的模块
没有什么区别了。</p>
<p>Linux内核中包含很多硬件的驱动，这些驱动大部分都会被实现为动态模块。因为不是每个
硬件平台都有这些硬件，包含这些驱动并没有意义。但LKM并不一定是硬件驱动，硬件驱动
也不需要一定是LKM。</p>
</div>
<div class="section" id="id6">
<h2>驱动框架<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h2>
<p>驱动管理是操作系统一个非常重要的功能。操作系统把所有的资源按相同的方式提供给用户，
比如，无论用户使用什么磁盘，从操作系统看来都是一样的文件系统，这就需要有一些模块
负责把不同形态的硬件封装成统一的样式。这些代码，就称为这种硬件的“驱动”，或者“驱
动程序”。</p>
<p>驱动是代码。在一些操作系统中，操作系统只包含很少的一部分驱动代码，其他代码通过
类似LKM那样的技术动态加载（但这不是必须的，部分操作系统也可以用进程作为驱动），
而且这些动态加载的程序和OS没有密切关系，可以一定程度上有不同的版本偏离。比如1.0
版本的驱动，可以用于1.0, 2.0, 2.1版本的操作系统中。</p>
<p>所以很多用户对驱动的理解类似一个类似进程一样的独立实体。但Linux不是这样的，
Linux的驱动是内核的一部分，它们没有互相分离的版本，默认两者是一同编译的。但正如
我们一直说的，每种架构判断都有可能有人做变种，我们这里只讨论设计意图。无论如何
我们基本上可以认为驱动是整个Linux内核大程序的一个模块。</p>
<p>驱动管理面对的一个主要问题是驱动和被驱动的那个硬件的对应关系。同一种类型的多个
设备，我们只需要一个驱动。同时，同一个设备，我们可以用不同的驱动去驱动它（比如
可能一个驱动用于本地使用，一个驱动用于虚拟机使用）。所以，硬件设备，和驱动这个
硬件设备的驱动程序，属于不同的两个实体。Linux内核在数据结构上用三个结构去管理驱
动和设备：</p>
<ul class="simple">
<li>struct driver，表示一个驱动。</li>
<li>struct device，表示一个设备。物理的总线也可以是一个device。</li>
<li>struct bus_type，表示一种总线类型，这是一个逻辑概念，不需要表示一条真实存在的
总线。它用于关联driver和device。在本小结中，我们把它简称为bus。</li>
</ul>
<p>bus_type通常是一个静态的结构，表示某种类型的总线，driver和device都可以注册到
bus_type中，bus_type有机制保证任意一方注册到总线中，它就可以通过一个bus专属的
match函数，判断两者是否匹配（比如PCI总线可以匹配driver支持什么vendor和device id
，然后匹配加进来的device的vendor和device id是否一致，如果一致，就说明两者匹配成
功了），如果匹配，就调用driver提供的probe函数，用struct device作为输入，驱动就
可以用device的数据初始化硬件，并且把这个硬件注册到特定的子系统中了。</p>
<p>整个逻辑组织起来就是这样的：</p>
<ol class="arabic simple">
<li>内核启动的初期，初始化程序创建一些基本的bus_type。</li>
<li>内核启动或者LKM插入的时候，驱动程序负责向自己支持的总线注册自己的驱动接口。</li>
<li>硬件平台初始化代码根据硬件平台的特点创建device，注册给不同的总线。这个可以硬
编码，也可以是对device tree或者ACPI配置的解释。也注册到对应的总线上。</li>
</ol>
<ol class="arabic simple" start="3">
<li>2, 3两步不分先后，如果匹配上，就会产生probe，probe负责初始化硬件，并注册子
系统</li>
<li>注册的设备中如果包含总线控制器，它可以创建更多的bus_type，然后扫描自己的总线
，把设备加入这个新的总线中。它也可以直接把新的设备加入已经存在的bus_type中。</li>
</ol>
<p>所以，最终如果有driver没有device，driver就只是闲着，有device没有driver，device
也只是闲着。Linux还有其他机制在device加入bus的时候通知用户态的helper，尝试找一
个匹配的LKM插入内核以驱动这个device。这是另一套逻辑，而且不是主要的逻辑，我们这
里忽略。</p>
<p>driver, bus, device都是“对象”，Linux使用kobject来管理它们（kobject的概念我们在
下个小节介绍），在Linux启动后，我们可以从sysfs上查看这些对象。sysfs通常被大部分
发行版mount在/sys目录中，下面是一个/sys/bus的内容：:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ac97</span>         <span class="n">container</span>  <span class="n">event_source</span>  <span class="n">isa</span>           <span class="n">memory</span>    <span class="n">nvmem</span>        <span class="n">platform</span>  <span class="n">serial</span>       <span class="n">typec</span>   <span class="n">workqueue</span>
<span class="n">acpi</span>         <span class="n">cpu</span>        <span class="n">gpio</span>          <span class="n">machinecheck</span>  <span class="n">mipi</span><span class="o">-</span><span class="n">dsi</span>  <span class="n">parport</span>      <span class="n">pnp</span>       <span class="n">serio</span>        <span class="n">usb</span>     <span class="n">xen</span>
<span class="n">cec</span>          <span class="n">dax</span>        <span class="n">hdaudio</span>       <span class="n">mdio_bus</span>      <span class="n">mmc</span>       <span class="n">pci</span>          <span class="n">rapidio</span>   <span class="n">snd_seq</span>      <span class="n">virtio</span>  <span class="n">xen</span><span class="o">-</span><span class="n">backend</span>
<span class="n">clockevents</span>  <span class="n">edac</span>       <span class="n">hid</span>           <span class="n">media</span>         <span class="n">nd</span>        <span class="n">pci</span><span class="o">-</span><span class="n">epf</span>      <span class="n">scsi</span>      <span class="n">spi</span>          <span class="n">vme</span>
<span class="n">clocksource</span>  <span class="n">eisa</span>       <span class="n">i2c</span>           <span class="n">mei</span>           <span class="n">node</span>      <span class="n">pci_express</span>  <span class="n">sdio</span>      <span class="n">thunderbolt</span>  <span class="n">wmi</span>
</pre></div>
</div>
<p>我们看pci_express的内容：:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">2</span> <span class="n">root</span> <span class="n">root</span>    <span class="mi">0</span> <span class="mi">3</span><span class="n">月</span>   <span class="mi">5</span> <span class="mi">15</span><span class="p">:</span><span class="mi">17</span> <span class="n">devices</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">6</span> <span class="n">root</span> <span class="n">root</span>    <span class="mi">0</span> <span class="mi">3</span><span class="n">月</span>   <span class="mi">5</span> <span class="mi">15</span><span class="p">:</span><span class="mi">17</span> <span class="n">drivers</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">4096</span> <span class="mi">3</span><span class="n">月</span>   <span class="mi">5</span> <span class="mi">15</span><span class="p">:</span><span class="mi">17</span> <span class="n">drivers_autoprobe</span>
<span class="o">--</span><span class="n">w</span><span class="o">-------</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">4096</span> <span class="mi">3</span><span class="n">月</span>   <span class="mi">5</span> <span class="mi">15</span><span class="p">:</span><span class="mi">17</span> <span class="n">drivers_probe</span>
<span class="o">--</span><span class="n">w</span><span class="o">-------</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">4096</span> <span class="mi">3</span><span class="n">月</span>   <span class="mi">5</span> <span class="mi">15</span><span class="p">:</span><span class="mi">17</span> <span class="n">uevent</span>
</pre></div>
</div>
<p>devices和drivers目录指向对应的devices和drivers的kobject所在的目录。
drivers_autoprobe等文件称为这个kobject的“属性”，可以通过读写这些属性改变这个
kobject的行为。比如，我们可以通过driver的unbind属性强行解绑定一个device等等。</p>
<p>对于服务器，最重要的两个bus_type是platform和pci。前者用于没有总线控制，无条件连
接的设备，这种总线的匹配通常就只能是字符串匹配。后者用于PCI和PCIe等设备的匹配，
配备方法就是PCI协议规定的Vendor和Device ID匹配了。</p>
<p>我们看看这个概念体现在驱动的代码的时候是什么样的。以hns_enet为例子，它就是一个
platform设备，它的driver定义是这样的：</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">hns_enet_of_match</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">{.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;hisilicon,hns-nic-v1&quot;</span><span class="p">,},</span>
        <span class="p">{.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;hisilicon,hns-nic-v2&quot;</span><span class="p">,},</span>
        <span class="p">{},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">acpi_device_id</span> <span class="n">hns_enet_acpi_match</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">{</span> <span class="s">&quot;HISI00C1&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
        <span class="p">{</span> <span class="s">&quot;HISI00C2&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
        <span class="p">{</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">hns_nic_dev_driver</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
                <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;hns-nic&quot;</span><span class="p">,</span>
                <span class="p">.</span><span class="n">of_match_table</span> <span class="o">=</span> <span class="n">hns_enet_of_match</span><span class="p">,</span>
                <span class="p">.</span><span class="n">acpi_match_table</span> <span class="o">=</span> <span class="n">ACPI_PTR</span><span class="p">(</span><span class="n">hns_enet_acpi_match</span><span class="p">),</span>
        <span class="p">},</span>
        <span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">hns_nic_dev_probe</span><span class="p">,</span>
        <span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">hns_nic_dev_remove</span><span class="p">,</span>
<span class="p">};</span>
</pre></div>
</div>
<p>这里提供了对device tree（of_mastch_table）和ACPI两个匹配表，任何一个配置文件
中描述了这个设备，都可以匹配这个驱动。</p>
<p>而鲲鹏920使用PCIe设备，它的driver定义就是这样的：</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">hns3_pci_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">HUAWEI</span><span class="p">,</span> <span class="n">HNAE3_DEV_ID_GE</span><span class="p">),</span> <span class="mi">0</span><span class="p">},</span>
        <span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">HUAWEI</span><span class="p">,</span> <span class="n">HNAE3_DEV_ID_25GE</span><span class="p">),</span> <span class="mi">0</span><span class="p">},</span>
        <span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">HUAWEI</span><span class="p">,</span> <span class="n">HNAE3_DEV_ID_25GE_RDMA</span><span class="p">),</span>
         <span class="n">HNAE3_DEV_SUPPORT_ROCE_DCB_BITS</span><span class="p">},</span>
        <span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">HUAWEI</span><span class="p">,</span> <span class="n">HNAE3_DEV_ID_25GE_RDMA_MACSEC</span><span class="p">),</span>
         <span class="n">HNAE3_DEV_SUPPORT_ROCE_DCB_BITS</span><span class="p">},</span>
        <span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">HUAWEI</span><span class="p">,</span> <span class="n">HNAE3_DEV_ID_50GE_RDMA</span><span class="p">),</span>
         <span class="n">HNAE3_DEV_SUPPORT_ROCE_DCB_BITS</span><span class="p">},</span>
        <span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">HUAWEI</span><span class="p">,</span> <span class="n">HNAE3_DEV_ID_50GE_RDMA_MACSEC</span><span class="p">),</span>
         <span class="n">HNAE3_DEV_SUPPORT_ROCE_DCB_BITS</span><span class="p">},</span>
        <span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">HUAWEI</span><span class="p">,</span> <span class="n">HNAE3_DEV_ID_100G_RDMA_MACSEC</span><span class="p">),</span>
         <span class="n">HNAE3_DEV_SUPPORT_ROCE_DCB_BITS</span><span class="p">},</span>
        <span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">HUAWEI</span><span class="p">,</span> <span class="n">HNAE3_DEV_ID_100G_VF</span><span class="p">),</span> <span class="mi">0</span><span class="p">},</span>
        <span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">HUAWEI</span><span class="p">,</span> <span class="n">HNAE3_DEV_ID_100G_RDMA_DCB_PFC_VF</span><span class="p">),</span>
         <span class="n">HNAE3_DEV_SUPPORT_ROCE_DCB_BITS</span><span class="p">},</span>
        <span class="cm">/* required last entry */</span>
        <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">hns3_driver</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="n">hns3_driver_name</span><span class="p">,</span>
        <span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">hns3_pci_tbl</span><span class="p">,</span>
        <span class="p">.</span><span class="n">probe</span>    <span class="o">=</span> <span class="n">hns3_probe</span><span class="p">,</span>
        <span class="p">.</span><span class="n">remove</span>   <span class="o">=</span> <span class="n">hns3_remove</span><span class="p">,</span>
        <span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span> <span class="n">hns3_shutdown</span><span class="p">,</span>
        <span class="p">.</span><span class="n">sriov_configure</span> <span class="o">=</span> <span class="n">hns3_pci_sriov_configure</span><span class="p">,</span>
        <span class="p">.</span><span class="n">err_handler</span>    <span class="o">=</span> <span class="o">&amp;</span><span class="n">hns3_err_handler</span><span class="p">,</span>
<span class="p">};</span>
</pre></div>
</div>
<p>这里提供了一张PCI专用的id_table，给出每个支持的设备的Vendor ID和Device ID，匹配
上了也是调用probe函数。</p>
</div>
<div class="section" id="id7">
<h2>内核对象树<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h2>
<p>理解Linux内核常常还会涉及内核对象树的概念。从纯粹的抽象概念上说，Linux内核中管
理了各种各样的对象。用户态常常需要获得这些对象的相关信息，比如我们需要知道系统
中有哪些设备，知道这些设备的属性是什么，等等。就需要通过特定的内核接口去获得这
些信息。</p>
<p>Linux早期主要依赖procfs来做这种通讯（主流的发行版通常把这个文件系统mount在/proc
目录下，但这不是必须的。但从另一方面来说，部分程序会把这个作为假设）。其原理是
在内核中模拟一种虚拟的文件系统，某个内核对象需要给用户态提供信息，就注册一些回
调函数到这个虚拟文件系统上，当用户程序读写这个文件系统的时候，依靠这些回调函数
来提供信息给用户进程，或者接受用户进程的控制。</p>
<p>比如下面是/proc/meminfo的内容，里面提供了内存子系统的大部分信息：:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MemTotal</span><span class="p">:</span>       <span class="mi">527035420</span> <span class="n">kB</span>
<span class="n">MemFree</span><span class="p">:</span>        <span class="mi">523934248</span> <span class="n">kB</span>
<span class="n">MemAvailable</span><span class="p">:</span>   <span class="mi">522525312</span> <span class="n">kB</span>
<span class="n">Buffers</span><span class="p">:</span>           <span class="mi">26236</span> <span class="n">kB</span>
<span class="n">Cached</span><span class="p">:</span>           <span class="mi">383776</span> <span class="n">kB</span>
<span class="n">SwapCached</span><span class="p">:</span>            <span class="mi">0</span> <span class="n">kB</span>
<span class="n">Active</span><span class="p">:</span>           <span class="mi">306672</span> <span class="n">kB</span>
<span class="n">Inactive</span><span class="p">:</span>         <span class="mi">275296</span> <span class="n">kB</span>
<span class="n">Active</span><span class="p">(</span><span class="n">anon</span><span class="p">):</span>     <span class="mi">173452</span> <span class="n">kB</span>
<span class="n">Inactive</span><span class="p">(</span><span class="n">anon</span><span class="p">):</span>     <span class="mi">1772</span> <span class="n">kB</span>
<span class="n">Active</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>     <span class="mi">133220</span> <span class="n">kB</span>
<span class="n">Inactive</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>   <span class="mi">273524</span> <span class="n">kB</span>
<span class="n">Unevictable</span><span class="p">:</span>           <span class="mi">0</span> <span class="n">kB</span>
<span class="n">Mlocked</span><span class="p">:</span>               <span class="mi">0</span> <span class="n">kB</span>
<span class="n">SwapTotal</span><span class="p">:</span>       <span class="mi">2097148</span> <span class="n">kB</span>
<span class="n">SwapFree</span><span class="p">:</span>        <span class="mi">2097148</span> <span class="n">kB</span>
<span class="n">Dirty</span><span class="p">:</span>                <span class="mi">24</span> <span class="n">kB</span>
<span class="o">...</span>
</pre></div>
</div>
<p>它的代码实现在这里：</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">fs</span><span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">meminfo</span><span class="p">.</span><span class="n">c</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="n">proc_meminfo_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">proc_create_single</span><span class="p">(</span><span class="s">&quot;meminfo&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">meminfo_proc_show</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>这就仅仅注册了一个读函数，meminfo_proc_show()，所以文件只读，用户态读这个文件，
就由这个函数提供内容。函数内部只要向内存中写字符串就可以了。</p>
<p>这种方法简单，但不标准，特别对于设备一类的对象，这种方式不好管理。所以Linux内核
又引入了一个抽象的概念，称为kobject，其工作原理和/proc几乎是一样的，但它提供更
多的抽象，比如它有对象属性，对象索引，父对象，子对象，对象类型，对象集合一类的
的概念。大部分发行版会把这个文件系统Mount在/sys目录中。当然，如前所述，这也不是
必须的。</p>
<p>/sys在层次关系表达上比procfs更清楚，比如/sys/bus中包含了前面提过的所有的
bus_type：:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@host</span><span class="p">:</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">bus</span><span class="c1"># ls</span>
<span class="n">acpi</span>         <span class="n">container</span>     <span class="n">genpd</span>            <span class="n">mdio_bus</span>  <span class="n">nd</span>       <span class="n">pci_express</span>    <span class="n">scsi</span>    <span class="n">spi</span>        <span class="n">xen</span>
<span class="n">amba</span>         <span class="n">cpu</span>           <span class="n">gpio</span>             <span class="n">memory</span>    <span class="n">node</span>     <span class="n">platform</span>       <span class="n">sdio</span>    <span class="n">usb</span>        <span class="n">xen</span><span class="o">-</span><span class="n">backend</span>
<span class="n">cec</span>          <span class="n">edac</span>          <span class="n">hid</span>              <span class="n">mipi</span><span class="o">-</span><span class="n">dsi</span>  <span class="n">nvmem</span>    <span class="n">pnp</span>            <span class="n">serial</span>  <span class="n">virtio</span>
<span class="n">clockevents</span>  <span class="n">event_source</span>  <span class="n">i2c</span>              <span class="n">mmc</span>       <span class="n">pci</span>      <span class="n">rapidio</span>        <span class="n">serio</span>   <span class="n">vme</span>
<span class="n">clocksource</span>  <span class="n">fsl</span><span class="o">-</span><span class="n">mc</span>        <span class="n">iscsi_flashnode</span>  <span class="n">mmc_rpmb</span>  <span class="n">pci</span><span class="o">-</span><span class="n">epf</span>  <span class="n">scmi_protocol</span>  <span class="n">soc</span>     <span class="n">workqueue</span>
</pre></div>
</div>
<p>而pci目录中给出了pci这个对象的属性：:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@host</span><span class="p">:</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">bus</span><span class="o">/</span><span class="n">pci</span><span class="c1"># ls</span>
<span class="n">devices</span>  <span class="n">drivers</span>  <span class="n">drivers_autoprobe</span>  <span class="n">drivers_probe</span>  <span class="n">rescan</span>  <span class="n">resource_alignment</span>  <span class="n">slots</span>  <span class="n">uevent</span>
</pre></div>
</div>
<p>其中devices和driver是在这个对象上注册的所有设备和驱动：:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@host</span><span class="p">:</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">bus</span><span class="o">/</span><span class="n">pci</span><span class="o">/</span><span class="n">devices</span><span class="c1"># ls</span>
<span class="mi">0000</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.0</span>  <span class="mi">0000</span><span class="p">:</span><span class="mi">02</span><span class="p">:</span><span class="mf">00.0</span>  <span class="mi">0000</span><span class="p">:</span><span class="mi">74</span><span class="p">:</span><span class="mf">01.0</span>  <span class="mi">0000</span><span class="p">:</span><span class="mi">79</span><span class="p">:</span><span class="mf">00.0</span>  <span class="mi">0000</span><span class="p">:</span><span class="mi">7</span><span class="n">d</span><span class="p">:</span><span class="mf">00.2</span>  <span class="mi">0000</span><span class="p">:</span><span class="mi">86</span><span class="p">:</span><span class="mf">00.0</span>  <span class="mi">0000</span><span class="p">:</span><span class="n">b4</span><span class="p">:</span><span class="mf">00.0</span>  <span class="mi">0000</span><span class="p">:</span><span class="n">b8</span><span class="p">:</span><span class="mf">01.0</span>
<span class="mi">0000</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">08.0</span>  <span class="mi">0000</span><span class="p">:</span><span class="mi">03</span><span class="p">:</span><span class="mf">00.0</span>  <span class="mi">0000</span><span class="p">:</span><span class="mi">74</span><span class="p">:</span><span class="mf">02.0</span>  <span class="mi">0000</span><span class="p">:</span><span class="mi">7</span><span class="n">a</span><span class="p">:</span><span class="mf">00.0</span>  <span class="mi">0000</span><span class="p">:</span><span class="mi">7</span><span class="n">d</span><span class="p">:</span><span class="mf">00.3</span>  <span class="mi">0000</span><span class="p">:</span><span class="mi">86</span><span class="p">:</span><span class="mf">01.0</span>  <span class="mi">0000</span><span class="p">:</span><span class="n">b4</span><span class="p">:</span><span class="mf">01.0</span>  <span class="mi">0000</span><span class="p">:</span><span class="n">b9</span><span class="p">:</span><span class="mf">00.0</span>
<span class="mi">0000</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">0</span><span class="n">c</span><span class="o">.</span><span class="mi">0</span>  <span class="mi">0000</span><span class="p">:</span><span class="mi">03</span><span class="p">:</span><span class="mf">00.1</span>  <span class="mi">0000</span><span class="p">:</span><span class="mi">74</span><span class="p">:</span><span class="mf">03.0</span>  <span class="mi">0000</span><span class="p">:</span><span class="mi">7</span><span class="n">a</span><span class="p">:</span><span class="mf">01.0</span>  <span class="mi">0000</span><span class="p">:</span><span class="mi">80</span><span class="p">:</span><span class="mf">00.0</span>  <span class="mi">0000</span><span class="p">:</span><span class="mi">86</span><span class="p">:</span><span class="mf">02.0</span>  <span class="mi">0000</span><span class="p">:</span><span class="n">b4</span><span class="p">:</span><span class="mf">02.0</span>  <span class="mi">0000</span><span class="p">:</span><span class="n">bb</span><span class="p">:</span><span class="mf">00.0</span>
<span class="mi">0000</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">10.0</span>  <span class="mi">0000</span><span class="p">:</span><span class="mi">03</span><span class="p">:</span><span class="mf">00.2</span>  <span class="mi">0000</span><span class="p">:</span><span class="mi">74</span><span class="p">:</span><span class="mf">04.0</span>  <span class="mi">0000</span><span class="p">:</span><span class="mi">7</span><span class="n">a</span><span class="p">:</span><span class="mf">02.0</span>  <span class="mi">0000</span><span class="p">:</span><span class="mi">80</span><span class="p">:</span><span class="mf">04.0</span>  <span class="mi">0000</span><span class="p">:</span><span class="mi">86</span><span class="p">:</span><span class="mf">03.0</span>  <span class="mi">0000</span><span class="p">:</span><span class="n">b4</span><span class="p">:</span><span class="mf">03.0</span>  <span class="mi">0000</span><span class="p">:</span><span class="n">bc</span><span class="p">:</span><span class="mf">00.0</span>
<span class="mi">0000</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">11.0</span>  <span class="mi">0000</span><span class="p">:</span><span class="mi">03</span><span class="p">:</span><span class="mf">00.3</span>  <span class="mi">0000</span><span class="p">:</span><span class="mi">75</span><span class="p">:</span><span class="mf">00.0</span>  <span class="mi">0000</span><span class="p">:</span><span class="mi">7</span><span class="n">b</span><span class="p">:</span><span class="mf">00.0</span>  <span class="mi">0000</span><span class="p">:</span><span class="mi">80</span><span class="p">:</span><span class="mf">08.0</span>  <span class="mi">0000</span><span class="p">:</span><span class="mi">87</span><span class="p">:</span><span class="mf">00.0</span>  <span class="mi">0000</span><span class="p">:</span><span class="n">b4</span><span class="p">:</span><span class="mf">04.0</span>  <span class="mi">0000</span><span class="p">:</span><span class="n">bd</span><span class="p">:</span><span class="mf">00.0</span>
<span class="mi">0000</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">12.0</span>  <span class="mi">0000</span><span class="p">:</span><span class="mi">04</span><span class="p">:</span><span class="mf">00.0</span>  <span class="mi">0000</span><span class="p">:</span><span class="mi">76</span><span class="p">:</span><span class="mf">00.0</span>  <span class="mi">0000</span><span class="p">:</span><span class="mi">7</span><span class="n">c</span><span class="p">:</span><span class="mf">00.0</span>  <span class="mi">0000</span><span class="p">:</span><span class="mi">80</span><span class="p">:</span><span class="mi">0</span><span class="n">c</span><span class="o">.</span><span class="mi">0</span>  <span class="mi">0000</span><span class="p">:</span><span class="mi">88</span><span class="p">:</span><span class="mf">00.0</span>  <span class="mi">0000</span><span class="p">:</span><span class="n">b5</span><span class="p">:</span><span class="mf">00.0</span>  <span class="mi">0000</span><span class="p">:</span><span class="n">bd</span><span class="p">:</span><span class="mf">00.1</span>
<span class="mi">0000</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="mf">00.0</span>  <span class="mi">0000</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">00.0</span>  <span class="mi">0000</span><span class="p">:</span><span class="mi">78</span><span class="p">:</span><span class="mf">00.0</span>  <span class="mi">0000</span><span class="p">:</span><span class="mi">7</span><span class="n">d</span><span class="p">:</span><span class="mf">00.0</span>  <span class="mi">0000</span><span class="p">:</span><span class="mi">80</span><span class="p">:</span><span class="mf">10.0</span>  <span class="mi">0000</span><span class="p">:</span><span class="mi">89</span><span class="p">:</span><span class="mf">00.0</span>  <span class="mi">0000</span><span class="p">:</span><span class="n">b6</span><span class="p">:</span><span class="mf">00.0</span>  <span class="mi">0000</span><span class="p">:</span><span class="n">bd</span><span class="p">:</span><span class="mf">00.2</span>
<span class="mi">0000</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="mf">00.1</span>  <span class="mi">0000</span><span class="p">:</span><span class="mi">74</span><span class="p">:</span><span class="mf">00.0</span>  <span class="mi">0000</span><span class="p">:</span><span class="mi">78</span><span class="p">:</span><span class="mf">01.0</span>  <span class="mi">0000</span><span class="p">:</span><span class="mi">7</span><span class="n">d</span><span class="p">:</span><span class="mf">00.1</span>  <span class="mi">0000</span><span class="p">:</span><span class="mi">85</span><span class="p">:</span><span class="mf">00.0</span>  <span class="mi">0000</span><span class="p">:</span><span class="mi">8</span><span class="n">a</span><span class="p">:</span><span class="mf">00.0</span>  <span class="mi">0000</span><span class="p">:</span><span class="n">b8</span><span class="p">:</span><span class="mf">00.0</span>  <span class="mi">0000</span><span class="p">:</span><span class="n">bd</span><span class="p">:</span><span class="mf">00.3</span>

<span class="n">root</span><span class="nd">@host</span><span class="p">:</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">bus</span><span class="o">/</span><span class="n">pci</span><span class="o">/</span><span class="n">drivers</span><span class="c1"># ls</span>
<span class="n">ahci</span>        <span class="n">ehci</span><span class="o">-</span><span class="n">pci</span>   <span class="n">hinic</span>           <span class="n">hns3</span>  <span class="n">imsttfb</span>  <span class="n">ixgbe</span>         <span class="n">ohci</span><span class="o">-</span><span class="n">pci</span>  <span class="n">serial</span>  <span class="n">uhci_hcd</span>    <span class="n">xhci_hcd</span>
<span class="n">asiliantfb</span>  <span class="n">hibmc</span><span class="o">-</span><span class="n">drm</span>  <span class="n">hisi_sas_v3_hw</span>  <span class="n">igb</span>   <span class="n">ipmi_si</span>  <span class="n">megaraid_sas</span>  <span class="n">pcieport</span>  <span class="n">shpchp</span>  <span class="n">virtio</span><span class="o">-</span><span class="n">pci</span>
</pre></div>
</div>
<p>这里的设备是一个对象链接，如果我们详细看文件的属性，就是这样的：:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@host</span><span class="p">:</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">bus</span><span class="o">/</span><span class="n">pci</span><span class="o">/</span><span class="n">devices</span><span class="c1"># ls -l</span>
<span class="o">...</span>
<span class="n">lrwxrwxrwx</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">0</span> <span class="n">Mar</span> <span class="mi">12</span> <span class="mi">01</span><span class="p">:</span><span class="mi">08</span> <span class="mi">0000</span><span class="p">:</span><span class="n">bd</span><span class="p">:</span><span class="mf">00.0</span> <span class="o">-&gt;</span> <span class="o">../../../</span><span class="n">devices</span><span class="o">/</span><span class="n">pci0000</span><span class="p">:</span><span class="n">bc</span><span class="o">/</span><span class="mi">0000</span><span class="p">:</span><span class="n">bc</span><span class="p">:</span><span class="mf">00.0</span><span class="o">/</span><span class="mi">0000</span><span class="p">:</span><span class="n">bd</span><span class="p">:</span><span class="mf">00.0</span>
<span class="n">lrwxrwxrwx</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">0</span> <span class="n">Mar</span> <span class="mi">12</span> <span class="mi">01</span><span class="p">:</span><span class="mi">08</span> <span class="mi">0000</span><span class="p">:</span><span class="n">bd</span><span class="p">:</span><span class="mf">00.1</span> <span class="o">-&gt;</span> <span class="o">../../../</span><span class="n">devices</span><span class="o">/</span><span class="n">pci0000</span><span class="p">:</span><span class="n">bc</span><span class="o">/</span><span class="mi">0000</span><span class="p">:</span><span class="n">bc</span><span class="p">:</span><span class="mf">00.0</span><span class="o">/</span><span class="mi">0000</span><span class="p">:</span><span class="n">bd</span><span class="p">:</span><span class="mf">00.1</span>
<span class="n">lrwxrwxrwx</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">0</span> <span class="n">Mar</span> <span class="mi">12</span> <span class="mi">01</span><span class="p">:</span><span class="mi">08</span> <span class="mi">0000</span><span class="p">:</span><span class="n">bd</span><span class="p">:</span><span class="mf">00.2</span> <span class="o">-&gt;</span> <span class="o">../../../</span><span class="n">devices</span><span class="o">/</span><span class="n">pci0000</span><span class="p">:</span><span class="n">bc</span><span class="o">/</span><span class="mi">0000</span><span class="p">:</span><span class="n">bc</span><span class="p">:</span><span class="mf">00.0</span><span class="o">/</span><span class="mi">0000</span><span class="p">:</span><span class="n">bd</span><span class="p">:</span><span class="mf">00.2</span>
<span class="n">lrwxrwxrwx</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">0</span> <span class="n">Mar</span> <span class="mi">12</span> <span class="mi">01</span><span class="p">:</span><span class="mi">08</span> <span class="mi">0000</span><span class="p">:</span><span class="n">bd</span><span class="p">:</span><span class="mf">00.3</span> <span class="o">-&gt;</span> <span class="o">../../../</span><span class="n">devices</span><span class="o">/</span><span class="n">pci0000</span><span class="p">:</span><span class="n">bc</span><span class="o">/</span><span class="mi">0000</span><span class="p">:</span><span class="n">bc</span><span class="p">:</span><span class="mf">00.0</span><span class="o">/</span><span class="mi">0000</span><span class="p">:</span><span class="n">bd</span><span class="p">:</span><span class="mf">00.3</span>
</pre></div>
</div>
<p>设备实际上首先是系统全体设备管理这个对象的管理之下，然后再被注册给pci bus_type
，pci bus_type再建立一个到这个设备的索引，这样，设备和各个管理系统的关系就被建
立起来了。</p>
<p>对象中可以有属性：:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@host</span><span class="p">:</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">bus</span><span class="o">/</span><span class="n">pci</span><span class="o">/</span><span class="n">devices</span><span class="o">/</span><span class="mi">0000</span><span class="p">:</span><span class="n">bd</span><span class="p">:</span><span class="mf">00.3</span><span class="c1"># ls -l</span>
<span class="n">ari_enabled</span>               <span class="n">d3cold_allowed</span>   <span class="n">iommu</span>           <span class="n">mdio_bus</span>   <span class="n">remove</span>     <span class="n">sriov_drivers_autoprobe</span>  <span class="n">subsystem_device</span>
<span class="n">broken_parity_status</span>      <span class="n">device</span>           <span class="n">iommu_group</span>     <span class="n">modalias</span>   <span class="n">rescan</span>     <span class="n">sriov_numvfs</span>             <span class="n">subsystem_vendor</span>
<span class="k">class</span>                     <span class="nc">devspec</span>          <span class="n">irq</span>             <span class="n">msi_bus</span>    <span class="n">reset</span>      <span class="n">sriov_offset</span>             <span class="n">uevent</span>
<span class="n">config</span>                    <span class="n">dma_mask_bits</span>    <span class="n">local_cpulist</span>   <span class="n">msi_irqs</span>   <span class="n">resource</span>   <span class="n">sriov_stride</span>             <span class="n">vendor</span>
<span class="n">consistent_dma_mask_bits</span>  <span class="n">driver</span>           <span class="n">local_cpus</span>      <span class="n">net</span>        <span class="n">resource0</span>  <span class="n">sriov_totalvfs</span>
<span class="n">current_link_speed</span>        <span class="n">driver_override</span>  <span class="n">max_link_speed</span>  <span class="n">numa_node</span>  <span class="n">resource2</span>  <span class="n">sriov_vf_device</span>
<span class="n">current_link_width</span>        <span class="n">enable</span>           <span class="n">max_link_width</span>  <span class="n">power</span>      <span class="n">revision</span>   <span class="n">subsystem</span>
</pre></div>
</div>
<p>这里每个文件就是这个设备对象的一个属性，它的内容就和前面提到的procfs的每个文件
的原理是一样的了。</p>
<p>kobject在内核中的实现代码不难理解，但细节很多，本文不深入进入讨论这些细节，仅让
读者了解这个设计的构架思路是什么。</p>
<blockquote>
<div><div class="line-block">
<div class="line">关于“架构思路”这个概念，我们补充解释一下。</div>
<div class="line">我们前面说的kobject的概念，并不是kobject实现的全部。</div>
<div class="line">比如说，kobject还有一个功能：如果有人创建了一个新的kobject，</div>
<div class="line">可以通过一个称为uevent的机制从用户态监听到。</div>
<div class="line">如果我们要完整谈kobject，就应该把uevent的特点也说清楚。</div>
<div class="line">但uevent在kobject概念之上的增加，它是否存在，</div>
<div class="line">基本不影响kobject的相关概念和逻辑，</div>
<div class="line">但如果kobject的概念和逻辑发生变化，</div>
<div class="line">uevent就必须发生重大的变化了。这时，</div>
<div class="line">我们就会聚焦到kobject的概念和逻辑的介绍上，</div>
<div class="line">而忽略uevent的相关逻辑，我们把这些我们优先表述的逻辑，</div>
<div class="line">称为“架构思路”。</div>
</div>
</div></blockquote>
<p>最后补充一句，kobject是个纯粹的抽象概念，它不和某种具体的实现绑定，它设计最初主
要是为了管理驱动和设备，但最终它能管理的不仅仅是驱动和设备，而可以是任何需要管
理的内核“对象”。Linux内核把sysfs的修改看做是对内核ABI的修改，如果有人修改了
sysfs的接口，需要在内核文档Documentation/ABI目录下增加相应的表述。所以一般看这个
目录的源代码就能了解所有这些对象和属性的用法。</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="地址空间.html" class="btn btn-neutral float-right" title="地址空间" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="软件构架.html" class="btn btn-neutral float-left" title="软件架构" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Kenneth Lee

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>